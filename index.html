<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>風箏選股交易紀錄系統 (Cloud v1.5.2 Fee Edition)</title>
    <link rel="apple-touch-icon" href="https://i.postimg.cc/vmnvYM81/Gemini-Generated-Image-54zn7d54zn7d54zn.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">    
    <link rel="icon" type="image/png" href="https://i.postimg.cc/vmnvYM81/Gemini-Generated-Image-54zn7d54zn7d54zn.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        indigo: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81', 950: '#1e1b4b', }
                    },
                    screens: { 'xs': '375px' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto+Sans+TC', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; touch-action: manipulation; overscroll-behavior-y: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; min-height: 100dvh; padding-bottom: env(safe-area-inset-bottom); }
        input, textarea { -webkit-user-select: text; user-select: text; font-size: 16px !important; }
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        .persona-card, .wind-card { cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .persona-card.selected { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        #p-freelancer.selected { border-color: #3b82f6; background-color: #eff6ff; }
        #p-office.selected { border-color: #6366f1; background-color: #eef2ff; }
        #p-boss.selected { border-color: #a855f7; background-color: #faf5ff; }
        .dark #p-freelancer.selected { background-color: rgba(59, 130, 246, 0.15); border-color: #60a5fa; }
        .dark #p-office.selected { background-color: rgba(99, 102, 241, 0.15); border-color: #818cf8; }
        .dark #p-boss.selected { background-color: rgba(168, 85, 247, 0.15); border-color: #c084fc; }
        .wind-card.selected.強風 { border-color: #ef4444; background-color: #fef2f2; }
        .wind-card.selected.亂流 { border-color: #f59e0b; background-color: #fffbeb; }
        .wind-card.selected.陣風 { border-color: #3b82f6; background-color: #eff6ff; }
        .wind-card.selected.無風 { border-color: #94a3b8; background-color: #f8fafc; }
        .dark .wind-card.selected.強風 { background-color: rgba(239, 68, 68, 0.15); border-color: #f87171; }
        .dark .wind-card.selected.亂流 { background-color: rgba(245, 158, 11, 0.15); border-color: #fbbf24; }
        .dark .wind-card.selected.陣風 { background-color: rgba(59, 130, 246, 0.15); border-color: #60a5fa; }
        .dark .wind-card.selected.無風 { background-color: rgba(148, 163, 184, 0.15); border-color: #94a3b8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .smooth-scroll { -webkit-overflow-scrolling: touch; }
        .tab-button.active { background-color: white; color: #4f46e5; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .dark .tab-button.active { background-color: #312e81; color: #e0e7ff; }
        .blur-login { filter: blur(8px); pointer-events: none; user-select: none; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .matrix-cell { transition: all 0.2s; }
        .modal-content { max-height: 85dvh; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: slideDown 0.2s ease-in-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-[100dvh] pb-safe bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 relative overflow-x-hidden">

    <div id="login-overlay" class="fixed inset-0 z-[500] flex flex-col items-center justify-center p-6 bg-slate-50/90 dark:bg-slate-950/90 backdrop-blur-md transition-all duration-500 h-[100dvh]">
        <div class="w-full max-w-sm bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-2xl p-8 border border-slate-100 dark:border-slate-800 animate-in fade-in zoom-in duration-300">
            <div class="flex flex-col items-center text-center mb-8">
                <div class="w-20 h-20 rounded-3xl flex items-center justify-center shadow-xl shadow-indigo-500/30 mb-6 overflow-hidden">
                    <img src="https://i.postimg.cc/vmnvYM81/Gemini-Generated-Image-54zn7d54zn7d54zn.png" class="w-full h-full object-cover scale-150">
                </div>                <h1 class="text-3xl font-black mb-2 text-red-600 dark:text-red-500">交易紀錄</h1>
                <p class="text-sm text-slate-400 font-bold uppercase tracking-widest">Cloud Sync Active</p>
            </div>
            <div class="space-y-4">
                <button onclick="handleGoogleLogin()" id="btn-google" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-white font-bold py-5 rounded-2xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-all flex items-center justify-center gap-3 shadow-sm group text-lg btn-press">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    Google 帳號登入
                </button>
                <div class="text-center">
                    <p class="text-[10px] text-slate-400 font-bold">登入後資料將自動同步至雲端</p>
                </div>
            </div>
        </div>
    </div>

    <div id="app-content" class="max-w-5xl mx-auto px-4 py-4 transition-all duration-500 blur-login pb-24">
        <header class="mb-5">
            <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 xs:w-12 xs:h-12 rounded-xl flex items-center justify-center overflow-hidden shadow-lg shadow-indigo-500/20">
                            <img src="https://i.postimg.cc/vmnvYM81/Gemini-Generated-Image-54zn7d54zn7d54zn.png" class="w-full h-full object-cover scale-150">
                        </div>                        <div><h1 class="text-2xl xs:text-3xl font-black tracking-tight text-red-600 dark:text-red-500">交易紀錄</h1><p class="text-[10px] xs:text-xs text-slate-400 dark:text-slate-500 font-bold uppercase tracking-widest flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Cloud Online</p></div>
                    </div>
                    <div class="flex items-center gap-2 relative">
                        <div class="relative">
                            <button onclick="toggleUserMenu()" class="flex items-center gap-2 bg-white dark:bg-slate-900 rounded-2xl pl-1 pr-3 py-1.5 border border-slate-200 dark:border-slate-800 shadow-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition-all btn-press" id="user-btn">
                                <img id="user-avatar" src="" class="w-8 h-8 rounded-xl bg-slate-200 object-cover">
                                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 ml-1"></i>
                            </button>
                            <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-2xl shadow-xl z-[150] overflow-hidden">
                                <div class="px-5 py-4 border-b border-slate-50 dark:border-slate-800">
                                    <p class="text-xs font-bold text-slate-400 uppercase">帳號</p>
                                    <p class="text-sm font-black truncate" id="menu-user-name">Loading...</p>
                                </div>
                                <button onclick="openSettingsModal()" class="w-full px-5 py-3 text-left text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center gap-3 border-b border-slate-50 dark:border-slate-800">
                                    <i data-lucide="settings-2" class="w-4 h-4 text-slate-400"></i> 手續費設定
                                </button>
                                <button onclick="handleLogout()" class="w-full px-5 py-4 text-left text-sm font-bold text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-3"><i data-lucide="log-out" class="w-4 h-4"></i> 登出帳號</button>
                            </div>
                        </div>
                        <div class="relative">
                            <button onclick="toggleThemeMenu()" id="theme-toggle-btn" class="w-11 h-11 flex items-center justify-center rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-sm transition-all hover:bg-slate-100 dark:hover:bg-slate-800 btn-press">
                                <i data-lucide="sun" id="theme-icon-light" class="w-5 h-5 text-amber-500 hidden"></i><i data-lucide="moon" id="theme-icon-dark" class="w-5 h-5 text-indigo-400 hidden"></i><i data-lucide="monitor" id="theme-icon-auto" class="w-5 h-5 text-slate-400 hidden"></i>
                            </button>
                            <div id="theme-menu" class="hidden absolute right-0 mt-2 w-40 bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-2xl shadow-xl z-[150] overflow-hidden">
                                <button onclick="setTheme('light')" class="w-full px-5 py-3 text-left text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center gap-3"><i data-lucide="sun" class="w-4 h-4 text-amber-500"></i> 晝間模式</button>
                                <button onclick="setTheme('dark')" class="w-full px-5 py-3 text-left text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center gap-3"><i data-lucide="moon" class="w-4 h-4 text-indigo-400"></i> 夜間模式</button>
                                <button onclick="setTheme('system')" class="w-full px-5 py-3 text-left text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center gap-3 border-t dark:border-slate-800"><i data-lucide="monitor" class="w-4 h-4 text-slate-400"></i> 跟隨系統</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto no-scrollbar smooth-scroll -mx-4 px-4 pb-1">
                    <div class="glass-card bg-white dark:bg-slate-900 p-5 rounded-[2.5rem] shadow-xl shadow-slate-200/40 dark:shadow-none border border-transparent dark:border-slate-800 relative overflow-hidden min-w-[340px]">
                        <!-- 背景裝飾 -->
                        <div class="absolute -right-8 -top-8 w-40 h-40 bg-indigo-50 dark:bg-indigo-900/20 rounded-full blur-3xl pointer-events-none"></div>
                        
                        <!-- 上半部：總資產與本金 -->
                        <div class="relative z-10 mb-5 flex justify-between items-end">
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 flex items-center gap-1"><i data-lucide="wallet" class="w-3 h-3"></i> 目前資產總值</p>
                                <h2 id="header-total-assets" class="text-3xl xs:text-4xl font-black text-slate-800 dark:text-white tracking-tight leading-none">--</h2>
                            </div>
                            <div class="text-right pl-4">
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">投入本金</p>
                                <p id="header-initial-capital" class="text-sm font-black text-slate-600 dark:text-slate-300">--</p>
                            </div>
                        </div>

                        <!-- 分隔線 -->
                        <div class="h-px bg-slate-100 dark:bg-slate-800 mb-4"></div>

                        <!-- 下半部：詳細數據 Grid -->
                        <div class="grid grid-cols-2 gap-x-6 gap-y-4 relative z-10">
                            <!-- 左側：股票相關 -->
                            <div class="space-y-3">
                                <div><p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-0.5">持有股票市值</p><p id="header-market-value" class="text-base font-black text-slate-700 dark:text-slate-200">--</p></div>
                                <div><p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-0.5">未實現損益</p><div class="flex items-baseline gap-1.5"><span id="header-unrealized-pl" class="text-base font-black">--</span><span id="header-unrealized-pct" class="text-[10px] font-bold">--</span></div></div>
                            </div>

                            <!-- 右側：現金與已實現 -->
                            <div class="space-y-3 text-right">
                                <div><p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-0.5">剩餘可用資金</p><p id="header-available-cash" class="text-base font-black text-indigo-600 dark:text-indigo-400">--</p></div>
                                <div onclick="showStatsModal()" class="cursor-pointer group"><div class="flex items-center justify-end gap-1 mb-0.5"><p class="text-[9px] font-black text-slate-400 uppercase tracking-widest group-hover:text-indigo-500 transition-colors">已實現損益</p><i data-lucide="chevron-right" class="w-3 h-3 text-slate-300 group-hover:text-indigo-500 transition-colors"></i></div><p id="header-total-pl" class="text-base font-black">--</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <nav class="bg-slate-200/50 dark:bg-slate-900/50 p-1.5 rounded-2xl flex mb-6 shadow-inner overflow-x-auto no-scrollbar smooth-scroll sticky top-0 z-40 backdrop-blur-md">
            <button onclick="switchTab('add')" id="tab-add" class="tab-button active flex-1 py-3 px-3 xs:px-4 rounded-xl text-xs xs:text-sm font-black transition-all flex items-center justify-center gap-1.5 min-w-[80px] whitespace-nowrap btn-press">新增</button>
            <button onclick="switchTab('portfolio')" id="tab-portfolio" class="tab-button flex-1 py-3 px-3 xs:px-4 rounded-xl text-xs xs:text-sm font-black text-slate-500 transition-all flex items-center justify-center gap-1.5 min-w-[80px] whitespace-nowrap btn-press">庫存</button>
            <button onclick="switchTab('history')" id="tab-history" class="tab-button flex-1 py-3 px-3 xs:px-4 rounded-xl text-xs xs:text-sm font-black text-slate-500 transition-all flex items-center justify-center gap-1.5 min-w-[80px] whitespace-nowrap btn-press">歷史</button>
            <button onclick="switchTab('journal')" id="tab-journal" class="tab-button flex-1 py-3 px-3 xs:px-4 rounded-xl text-xs xs:text-sm font-black text-slate-500 transition-all flex items-center justify-center gap-1.5 min-w-[80px] whitespace-nowrap btn-press"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> 日誌</button>
            <button onclick="switchTab('strategy')" id="tab-strategy" class="tab-button flex-1 py-3 px-3 xs:px-4 rounded-xl text-xs xs:text-sm font-black text-slate-500 transition-all flex items-center justify-center gap-1.5 min-w-[80px] whitespace-nowrap btn-press"><i data-lucide="layout-grid" class="w-3.5 h-3.5"></i> 戰情</button>
        </nav>

        <div id="page-journal" class="hidden space-y-6 animate-in pb-20">
            <!-- Calendar UI will be rendered here -->
            <div id="calendar-container" class="bg-white dark:bg-slate-900 rounded-[2rem] p-5 shadow-sm border border-slate-50 dark:border-slate-800"></div>

            <div id="journal-details-container" class="hidden space-y-6 animate-in slide-in-from-bottom-4">

                <!-- Section 1: Trade List (Moved to Top) -->
                <div>
                    <div class="flex items-center justify-between mb-3 px-1">
                        <h3 class="text-lg font-black text-slate-800 dark:text-slate-100 flex items-center gap-2">
                            <i data-lucide="list-checks" class="w-5 h-5 text-indigo-500"></i> 當日交易明細
                        </h3>
                        <span id="journal-trade-count" class="text-xs font-bold text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-lg">--</span>
                    </div>
                    <div id="journal-trade-list" class="space-y-3"></div>
                </div>

                <!-- Section 2: Daily Log Editor (Moved to Bottom) -->
                <div class="bg-white dark:bg-slate-900 rounded-[2rem] p-5 shadow-sm border border-slate-50 dark:border-slate-800 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-black text-slate-800 dark:text-slate-100 flex items-center gap-2">
                            <i data-lucide="book-open" class="w-5 h-5 text-indigo-500"></i> 交易心得日記
                        </h3>
                        <h3 id="journal-date-title" class="text-xs font-black text-slate-400">--</h3>
                    </div>
                    <textarea id="journal-content" rows="6" class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-4 text-base focus:ring-2 focus:ring-indigo-500 font-bold mb-4 resize-none leading-relaxed" placeholder="記錄當下的情緒、策略執行狀況或明日規劃..."></textarea>
                    <button onclick="saveDailyLog()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-indigo-200 dark:shadow-none btn-press flex items-center justify-center gap-2 hover:bg-indigo-700 transition-colors">
                        <i data-lucide="save" class="w-4 h-4"></i> 儲存日誌
                    </button>
                    <div id="journal-status" class="text-center mt-2 text-[10px] font-bold text-slate-300"></div>
                </div>

            </div>
        </div>

        <div id="page-add" class="space-y-5 animate-in">
            <div class="flex items-center gap-3 mb-2 ml-1"><h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">選擇操作人格</h2><button type="button" onclick="showPersonaHelp()" class="text-slate-300 hover:text-indigo-500 p-2 -m-2"><i data-lucide="info" class="w-5 h-5"></i></button></div>
            <div class="grid grid-cols-3 gap-2 xs:gap-3">
                <div onclick="selectPersona('freelancer')" id="p-freelancer" class="persona-card group bg-white dark:bg-slate-900 p-2 xs:p-3 md:p-5 rounded-2xl xs:rounded-3xl border-2 border-transparent shadow-sm text-center hover:shadow-md dark:shadow-none transition-all btn-press"><div class="w-10 h-10 xs:w-12 xs:h-12 bg-blue-50 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center text-blue-600 dark:text-blue-400 mx-auto mb-2 xs:mb-3"><i data-lucide="zap" class="w-5 h-5 xs:w-6 xs:h-6"></i></div><h3 class="font-black text-xs xs:text-sm">打工型</h3></div>
                <div onclick="selectPersona('office')" id="p-office" class="persona-card group bg-white dark:bg-slate-900 p-2 xs:p-3 md:p-5 rounded-2xl xs:rounded-3xl border-2 border-transparent shadow-sm text-center hover:shadow-md dark:shadow-none transition-all btn-press"><div class="w-10 h-10 xs:w-12 xs:h-12 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center text-indigo-600 dark:text-indigo-400 mx-auto mb-2 xs:mb-3"><i data-lucide="briefcase" class="w-5 h-5 xs:w-6 xs:h-6"></i></div><h3 class="font-black text-xs xs:text-sm">上班族</h3></div>
                <div onclick="selectPersona('boss')" id="p-boss" class="persona-card group bg-white dark:bg-slate-900 p-2 xs:p-3 md:p-5 rounded-2xl xs:rounded-3xl border-2 border-transparent shadow-sm text-center hover:shadow-md dark:shadow-none transition-all btn-press"><div class="w-10 h-10 xs:w-12 xs:h-12 bg-purple-50 dark:bg-purple-900/30 rounded-2xl flex items-center justify-center text-purple-600 dark:text-purple-400 mx-auto mb-2 xs:mb-3"><i data-lucide="crown" class="w-5 h-5 xs:w-6 xs:h-6"></i></div><h3 class="font-black text-xs xs:text-sm">老闆型</h3></div>
            </div>
            <div id="form-container" class="hidden">
                <div class="bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl shadow-indigo-100 dark:shadow-none p-5 md:p-8 border border-slate-50 dark:border-slate-800 overflow-hidden relative">
                    <div id="persona-indicator" class="absolute top-0 left-0 w-1.5 h-full bg-indigo-600"></div>
                    <form id="tradeForm" class="space-y-6">
                        <div class="flex flex-col gap-4 border-b dark:border-slate-800 pb-5">
                            <div class="flex justify-between items-start">
                                <div><h2 class="text-lg xs:text-xl font-black">進場紀錄填寫</h2><p class="text-[10px] xs:text-xs text-slate-400 font-bold uppercase tracking-wider mt-1 leading-tight" id="persona-summary-text"></p></div>
                                <div id="sop-badge" class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-tighter shrink-0 ml-2">GUIDED</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="space-y-2">
                                <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">具體策略分支</label>
                                <div id="subStrategyContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                                <input type="hidden" id="subStrategyInput">
                            </div>
                            <div class="bg-indigo-50/50 dark:bg-slate-800/50 rounded-2xl p-4 border border-indigo-100 dark:border-slate-700/50 relative overflow-hidden">
                                <div class="flex items-center gap-2 mb-3"><div class="w-5 h-5 bg-indigo-600 rounded-full flex items-center justify-center text-white"><i data-lucide="check" class="w-3 h-3"></i></div><h4 class="text-xs font-black text-indigo-900 dark:text-indigo-300">戰略確認</h4></div>
                                <div class="grid grid-cols-1 gap-3 text-sm relative z-10">
                                    <div class="bg-white/60 dark:bg-slate-900/60 p-3 rounded-xl border border-red-100 dark:border-red-900/20">
                                        <span class="font-black text-red-500 dark:text-red-400 uppercase tracking-wider block mb-1 flex items-center gap-1 text-[10px]"><i data-lucide="alert-circle" class="w-3 h-3"></i> 停損機制</span>
                                        <p id="rule-sl" class="font-bold text-slate-700 dark:text-slate-300 leading-relaxed text-xs whitespace-pre-line">...</p>
                                    </div>
                                    <div class="bg-white/60 dark:bg-slate-900/60 p-3 rounded-xl border border-green-100 dark:border-green-900/20">
                                        <span class="font-black text-green-600 dark:text-green-400 uppercase tracking-wider block mb-1 flex items-center gap-1 text-[10px]"><i data-lucide="target" class="w-3 h-3"></i> 停利目標</span>
                                        <p id="rule-tp" class="font-bold text-slate-700 dark:text-slate-300 leading-relaxed text-xs whitespace-pre-line">...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">代號</label><input type="number" inputmode="numeric" id="symbolCode" placeholder="2330" required class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold"></div>
                                <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">名稱</label><input type="text" id="symbolName" placeholder="台積電" required class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">單價</label><input type="number" inputmode="decimal" id="entryPrice" step="0.01" required class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold"></div>
                                <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">股數</label><input type="number" inputmode="numeric" id="quantity" step="1" required class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold"></div>
                            </div>
                            <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">技術圖</label><div class="relative"><input type="file" id="tradeScreenshot" accept="image/*" class="hidden" onchange="handleImageUpload(event)"><label for="tradeScreenshot" class="cursor-pointer w-full bg-slate-50 dark:bg-slate-800 border-2 border-dashed border-slate-200 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-500 rounded-2xl p-3.5 flex items-center justify-center gap-3 transition-colors group btn-press"><div id="upload-placeholder" class="flex items-center gap-2 text-slate-400 group-hover:text-indigo-500"><i data-lucide="image-plus" class="w-5 h-5"></i><span class="text-sm font-bold">上傳/拍攝</span></div><div id="upload-preview-container" class="hidden flex items-center gap-3 w-full"><img id="upload-preview" src="" class="h-10 w-10 object-cover rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm"><span class="text-sm font-bold text-green-600 dark:text-green-400 flex-1">Ready</span><span class="text-xs text-slate-400 underline font-bold hover:text-red-500 p-2" onclick="clearImage(event)">重選</span></div></label></div></div>
                            <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">日期</label><input type="date" id="entryDate" required class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold appearance-none"></div>
                            
                            <div class="space-y-2"><div class="flex items-center gap-1 ml-1"><label class="text-xs font-black text-slate-400 uppercase tracking-widest">環境風度</label><button type="button" onclick="showWindHelp()" class="text-slate-300 hover:text-indigo-500"><i data-lucide="info" class="w-4 h-4"></i></button></div><div class="grid grid-cols-4 gap-2" id="entryWindContainer"><div onclick="selectWind('entry', '強風')" data-wind="強風" class="wind-card 強風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center btn-press"><p class="text-xs font-black">強風</p></div><div onclick="selectWind('entry', '亂流')" data-wind="亂流" class="wind-card 亂流 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center btn-press"><p class="text-xs font-black">亂流</p></div><div onclick="selectWind('entry', '陣風')" data-wind="陣風" class="wind-card 陣風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center btn-press"><p class="text-xs font-black">陣風</p></div><div onclick="selectWind('entry', '無風')" data-wind="無風" class="wind-card 無風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center btn-press"><p class="text-xs font-black">無風</p></div></div><input type="hidden" id="entryWindInput" value="強風"></div>
                            
                            <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">筆記</label><textarea id="note" rows="2" placeholder="備註..." class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold"></textarea></div>
                        </div>
                        <button type="button" onclick="handleTradeSubmit()" class="w-full bg-slate-950 dark:bg-indigo-600 text-white text-base font-black py-4 rounded-2xl hover:bg-indigo-700 dark:hover:bg-indigo-500 transition-all shadow-xl shadow-indigo-100 dark:shadow-none flex items-center justify-center gap-3 mt-4 btn-press"><i data-lucide="save" class="w-5 h-5"></i> 儲存交易</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="page-portfolio" class="hidden space-y-5 animate-in"><div id="portfolio-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20"></div></div>
        
        <div id="page-history" class="hidden space-y-5 animate-in"><div id="history-list" class="space-y-4 pb-20"></div></div>
        
        <div id="page-strategy" class="hidden space-y-6 animate-in pb-20">
            <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 dark:from-indigo-900 dark:to-slate-900 rounded-[2rem] p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-6 opacity-10"><i data-lucide="crosshair" class="w-24 h-24"></i></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="bg-white/20 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">Strategy Insight</span>
                    </div>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div><p class="text-indigo-200 text-[10px] font-bold uppercase mb-1">MVP 人格</p><h3 id="best-persona" class="text-2xl font-black">計算中...</h3></div>
                            <div><p class="text-indigo-200 text-[10px] font-bold uppercase mb-1">黃金風度</p><h3 id="best-wind" class="text-2xl font-black">計算中...</h3></div>
                        </div>
                        <div class="bg-red-500/20 rounded-2xl p-3 border border-red-500/30">
                            <p class="text-red-200 text-[10px] font-bold uppercase mb-1 flex items-center gap-1"><i data-lucide="skull" class="w-3 h-3"></i> 毒藥警示</p>
                            <h3 id="worst-combo" class="text-lg font-black text-white">計算中...</h3>
                            <p id="worst-combo-desc" class="text-red-200 text-[10px] mt-1 leading-relaxed">...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-900 rounded-[2rem] p-4 shadow-sm border border-slate-50 dark:border-slate-800">
                <div class="flex items-center justify-between mb-4 px-1">
                    <h3 class="text-base font-black text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4 text-indigo-500"></i> 資金權益曲線</h3>
                </div>
                <div class="relative w-full h-56">
                    <canvas id="equityChart" class="w-full h-full"></canvas>
                </div>
            </div>

            <div>
                <div class="flex items-center justify-between mb-3 px-1">
                    <h3 class="text-base font-black text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="grid" class="w-4 h-4 text-indigo-500"></i> 獲利矩陣 (含稅費)</h3>
                    <p class="text-[10px] text-slate-400 font-bold">往右滑動查看更多 →</p>
                </div>
                
                <div class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-900/30 rounded-2xl p-4 mb-4">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-xl bg-indigo-600 flex items-center justify-center text-white shrink-0">
                            <i data-lucide="info" class="w-4 h-4"></i>
                        </div>
                        <div class="flex-1 space-y-2">
                            <h4 class="text-sm font-black text-indigo-900 dark:text-indigo-200">矩陣說明</h4>
                            <div class="text-xs text-slate-700 dark:text-slate-300 space-y-1.5 leading-relaxed">
                                <p><span class="font-black">結構：</span>左側為操作人格（打工型/上班族/老闆型），上方為賣出時的環境風度（強風/亂流/陣風/無風）</p>
                                <p><span class="font-black">顏色：</span><span class="text-red-600 dark:text-red-400 font-bold">紅色</span> = 該組合獲利，<span class="text-green-600 dark:text-green-400 font-bold">綠色</span> = 該組合虧損，<span class="text-slate-400 font-bold">灰色</span> = 無交易記錄</p>
                                <p><span class="font-black">數字：</span>上方顯示<span class="font-bold">勝率百分比</span>，下方顯示<span class="font-bold">累計淨損益金額</span>（已含買賣手續費及證交稅）</p>
                                <p><span class="font-black">數據來源：</span>僅統計已平倉的完整交易記錄</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="relative">
                    <div class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-slate-50 dark:from-slate-950 to-transparent pointer-events-none z-10"></div>
                    <div class="overflow-x-auto no-scrollbar smooth-scroll pb-2 -mx-4 px-4">
                        <div class="min-w-[500px] grid grid-cols-5 gap-2" id="strategy-matrix"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-slate-950/70 backdrop-blur-md hidden flex items-center justify-center p-6 z-[300]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-8 max-w-xs w-full shadow-2xl animate-in zoom-in duration-300 text-center border border-slate-100 dark:border-slate-800">
            <div class="w-16 h-16 bg-red-50 dark:bg-red-900/20 rounded-3xl flex items-center justify-center text-red-500 mx-auto mb-4"><i data-lucide="alert-triangle" class="w-8 h-8"></i></div>
            <h3 class="text-xl font-black mb-2">確認刪除？</h3><p class="text-xs text-slate-500 font-bold mb-6">此動作無法復原。</p>
            <div class="flex gap-3"><button onclick="confirmAction()" class="flex-1 bg-red-500 text-white font-black py-3.5 rounded-2xl text-sm btn-press">確認</button><button onclick="closeConfirmModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold py-3.5 rounded-2xl text-sm btn-press">取消</button></div>
        </div>
    </div>

    <div id="detailsModal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden flex items-center justify-center p-4 z-[250]" onclick="closeDetailsModal()">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-lg w-full shadow-2xl animate-in zoom-in duration-300 max-h-[85dvh] flex flex-col modal-content overflow-y-auto no-scrollbar" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4 pb-4 border-b dark:border-slate-800">
                <div><h3 class="text-xl font-black" id="detail-title">交易明細</h3><p class="text-xs text-slate-400 font-bold mt-1" id="detail-subtitle">--</p></div>
                <button onclick="closeDetailsModal()" class="text-slate-400 bg-slate-100 dark:bg-slate-800 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="detail-list" class="space-y-3 pb-safe"></div>
        </div>
    </div>

    <div id="imageModal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-md hidden flex items-center justify-center p-4 z-[300]" onclick="closeImageModal()">
        <div class="relative w-full h-full flex items-center justify-center" onclick="event.stopPropagation()">
            <img id="fullImage" src="" class="max-w-full max-h-full rounded-lg shadow-2xl object-contain">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 bg-slate-800/80 text-white p-3 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>

    <div id="addPositionModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-sm w-full shadow-2xl animate-in zoom-in duration-300 overflow-y-auto no-scrollbar max-h-[90dvh]">
            <div class="flex items-center gap-3 mb-6 text-indigo-600"><div class="w-10 h-10 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl flex items-center justify-center"><i data-lucide="trending-up" class="w-5 h-5"></i></div><h3 class="text-xl font-black text-slate-900 dark:text-slate-100">倉位加碼</h3></div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">加碼價格</label><input type="number" inputmode="decimal" id="addPosPrice" step="0.01" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-indigo-500 font-black text-base"></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">加碼股數</label><input type="number" inputmode="numeric" id="addPosQty" step="1" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-indigo-500 font-black text-base"></div>
                </div>
                <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">加碼日期</label><input type="date" id="addPosDate" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-indigo-500 font-black text-base appearance-none"></div>
                <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">理由</label><textarea id="addPosNote" rows="2" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-indigo-500 font-bold text-base" placeholder="為何加碼？"></textarea></div>
                <div class="flex gap-3 pt-2"><button onclick="confirmAddPosition()" class="flex-[2] bg-indigo-600 text-white font-black py-4 rounded-2xl text-base btn-press">確認</button><button onclick="closeAddPositionModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold py-4 rounded-2xl text-base btn-press">取消</button></div>
            </div>
        </div>
    </div>

    <div id="sellModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-sm w-full shadow-2xl animate-in zoom-in duration-300 overflow-y-auto no-scrollbar max-h-[90dvh]">
            <div class="flex items-center gap-3 mb-6 text-red-500"><div class="w-10 h-10 bg-red-50 dark:bg-red-900/20 rounded-2xl flex items-center justify-center"><i data-lucide="log-out" class="w-5 h-5"></i></div><h3 class="text-xl font-black text-slate-900 dark:text-slate-100">平倉/減碼</h3></div>
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-2 mb-1">
                    <div class="bg-slate-50 dark:bg-slate-800 rounded-2xl p-3 text-center"><p class="text-[9px] text-slate-400 uppercase font-bold">持倉</p><p class="text-xl font-black text-slate-700 dark:text-slate-200" id="sell-current-qty">0</p></div>
                    <div class="bg-slate-50 dark:bg-slate-800 rounded-2xl p-3 text-center"><p class="text-[9px] text-slate-400 uppercase font-bold">成本</p><p class="text-xl font-black text-slate-700 dark:text-slate-200" id="sell-avg-cost">0</p></div>
                    <div class="bg-amber-50 dark:bg-amber-900/20 rounded-2xl p-3 text-center border border-amber-100 dark:border-amber-900/30"><p class="text-[9px] text-amber-600 dark:text-amber-400 uppercase font-bold">已付手續費</p><p class="text-xl font-black text-amber-600 dark:text-amber-400" id="sell-paid-fee">0</p></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">賣出價格</label><input type="number" inputmode="decimal" id="sellPrice" step="0.01" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-red-500 font-black text-base" oninput="updateSellEstimate()"></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">賣出股數</label><input type="number" inputmode="numeric" id="sellQty" step="1" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-red-500 font-black text-base" oninput="updateSellEstimate()"></div>
                </div>
                <div id="sell-estimate" class="hidden bg-slate-50 dark:bg-slate-800/50 p-3 rounded-2xl border border-slate-100 dark:border-slate-700 text-center"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1">預估淨損益</p><p class="text-base font-black" id="sell-estimate-val">--</p></div>
                <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">賣出日期</label><input type="date" id="sellDate" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-red-500 font-black text-base appearance-none"></div>
                <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">賣出理由</label><textarea id="sellNote" rows="2" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-red-500 font-bold text-base" placeholder="為何賣出？"></textarea></div>
                <div class="space-y-2">
                    <div class="flex items-center gap-1 ml-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">當下風度</label></div>
                    <div class="grid grid-cols-4 gap-2" id="exitWindContainer">
                        <div onclick="selectWind('exit', '強風')" data-wind="強風" class="wind-card 強風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center text-xs font-bold btn-press">強風</div>
                        <div onclick="selectWind('exit', '亂流')" data-wind="亂流" class="wind-card 亂流 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center text-xs font-bold btn-press">亂流</div>
                        <div onclick="selectWind('exit', '陣風')" data-wind="陣風" class="wind-card 陣風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center text-xs font-bold btn-press">陣風</div>
                        <div onclick="selectWind('exit', '無風')" data-wind="無風" class="wind-card 無風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center text-xs font-bold btn-press">無風</div>
                    </div>
                    <input type="hidden" id="exitWindInput" value="強風">
                </div>
                <div class="flex gap-3 pt-2"><button onclick="confirmSellAction()" class="flex-[2] bg-slate-900 dark:bg-indigo-600 text-white font-black py-4 rounded-2xl hover:bg-red-600 transition shadow-lg shadow-slate-200 dark:shadow-none text-base btn-press">賣出</button><button onclick="closeModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold py-4 rounded-2xl text-base btn-press">取消</button></div>
            </div>
        </div>
    </div>

    <div id="filterModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-sm w-full shadow-2xl animate-in zoom-in duration-300">
            <div class="flex items-center gap-3 mb-6"><div class="w-10 h-10 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center text-indigo-600 dark:text-indigo-400"><i data-lucide="calendar-range" class="w-5 h-5"></i></div><h3 class="text-xl font-black">區間查詢</h3></div>
            <div class="space-y-4">
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="quickSetDate('thisMonth')" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black py-3 rounded-2xl btn-press flex flex-col items-center gap-1"><i data-lucide="calendar" class="w-4 h-4"></i><span class="text-[10px]">本月</span></button>
                    <button onclick="quickSetDate('lastMonth')" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black py-3 rounded-2xl btn-press flex flex-col items-center gap-1"><i data-lucide="calendar-minus" class="w-4 h-4"></i><span class="text-[10px]">上月</span></button>
                    <button onclick="quickSetDate('thisYear')" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black py-3 rounded-2xl btn-press flex flex-col items-center gap-1"><i data-lucide="calendar-range" class="w-4 h-4"></i><span class="text-[10px]">今年</span></button>
                    <button onclick="quickSetDate('last30')" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black py-3 rounded-2xl btn-press flex flex-col items-center gap-1"><i data-lucide="hourglass" class="w-4 h-4"></i><span class="text-[10px]">近30天</span></button>
                </div>
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-3xl border border-slate-100 dark:border-slate-800/50 flex items-center gap-2">
                    <div class="flex-1"><label class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">From</label><input type="date" id="filterStartDate" class="w-full bg-transparent border-0 p-0 font-black text-slate-700 dark:text-slate-200 text-sm focus:ring-0"></div>
                    <div class="text-slate-300 dark:text-slate-600"><i data-lucide="arrow-right" class="w-4 h-4"></i></div>
                    <div class="flex-1 text-right"><label class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">To</label><input type="date" id="filterEndDate" class="w-full bg-transparent border-0 p-0 font-black text-slate-700 dark:text-slate-200 text-sm focus:ring-0 text-right"></div>
                </div>
                <div class="flex gap-3 pt-2"><button onclick="applyDateFilter()" class="flex-[2] bg-indigo-600 text-white font-bold py-3.5 rounded-2xl text-sm btn-press">套用篩選</button><button onclick="resetDateFilter()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold py-3.5 rounded-2xl text-sm btn-press">重設</button></div>
                <button onclick="hideFilterModal()" class="w-full text-slate-400 text-xs font-bold uppercase tracking-widest py-2">取消</button>
            </div>
        </div>
    </div>

    <div id="windHelpModal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden flex items-center justify-center p-4 z-[300]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-md w-full shadow-2xl animate-in zoom-in duration-300 max-h-[85dvh] flex flex-col modal-content overflow-y-auto no-scrollbar">
            <div class="flex items-center justify-between mb-4 pb-2 border-b dark:border-slate-800"><h3 class="text-xl font-black">風度圖規則</h3><button onclick="hideWindHelp()" class="text-slate-300 p-2"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="space-y-3 pb-safe">
                 <div class="p-4 rounded-3xl bg-red-50 dark:bg-red-950/20 border border-red-100 dark:border-red-900/30"><div class="flex items-center gap-3 mb-2"><div class="w-10 h-10 shrink-0 bg-red-500 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-lg shadow-red-500/30">強風</div><div><p class="font-black text-red-600 dark:text-red-400 text-base">勝率偏高</p><p class="text-[10px] text-red-400 dark:text-red-300 font-bold">適合：積極操作</p></div></div><p class="text-[11px] text-slate-600 dark:text-slate-300 leading-relaxed font-medium">櫃買 >= 20MA 且 MACD紅柱放大。</p></div>
                 <div class="p-4 rounded-3xl bg-amber-50 dark:bg-amber-950/20 border border-amber-100 dark:border-amber-900/30"><div class="flex items-center gap-3 mb-2"><div class="w-10 h-10 shrink-0 bg-amber-500 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-lg shadow-amber-500/30">亂流</div><div><p class="font-black text-amber-600 dark:text-amber-400 text-base">震盪整理</p><p class="text-[10px] text-amber-500 dark:text-amber-300 font-bold">適合：停利/縮手</p></div></div><p class="text-[11px] text-slate-600 dark:text-slate-300 leading-relaxed font-medium">櫃買 >= 20MA 但 MACD紅柱縮短。</p></div>
                 <div class="p-4 rounded-3xl bg-blue-50 dark:bg-blue-950/20 border border-blue-100 dark:border-blue-900/30"><div class="flex items-center gap-3 mb-2"><div class="w-10 h-10 shrink-0 bg-blue-500 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-lg shadow-blue-500/30">陣風</div><div><p class="font-black text-blue-600 dark:text-blue-400 text-base">空頭反彈</p><p class="text-[10px] text-blue-400 dark:text-blue-300 font-bold">適合：短打/觀察</p></div></div><p class="text-[11px] text-slate-600 dark:text-slate-300 leading-relaxed font-medium">櫃買 < 20MA 但 MACD綠柱縮短。</p></div>
                 <div class="p-4 rounded-3xl bg-slate-100 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700"><div class="flex items-center gap-3 mb-2"><div class="w-10 h-10 shrink-0 bg-slate-400 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-lg shadow-slate-400/30">無風</div><div><p class="font-black text-slate-600 dark:text-slate-400 text-base">多做多賠</p><p class="text-[10px] text-slate-400 dark:text-slate-500 font-bold">適合：空手休息</p></div></div><p class="text-[11px] text-slate-600 dark:text-slate-300 leading-relaxed font-medium">櫃買 < 20MA 且 MACD綠柱放大。</p></div>
            </div>
        </div>
    </div>
    
    <div id="personaHelpModal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden flex items-center justify-center p-4 z-[300]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] max-w-3xl w-full shadow-2xl animate-in zoom-in duration-300 max-h-[85dvh] flex flex-col modal-content overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-slate-100 dark:border-slate-800 shrink-0 bg-white dark:bg-slate-900 z-10">
                <h3 class="text-xl font-black">KITE 策略分支手冊</h3>
                <button onclick="hidePersonaHelp()" class="text-slate-300 hover:text-indigo-500 p-2 -mr-2"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="overflow-y-auto p-6 pt-4 space-y-6 text-sm leading-relaxed text-slate-600 dark:text-slate-300 pb-safe">
                
                <section class="space-y-3">
                    <h4 class="font-black text-blue-600 flex items-center gap-2 text-lg"><i data-lucide="zap" class="w-5 h-5"></i> 1. 打工型 (Freelancer) — 日級別</h4>
                    <p class="text-xs bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl border border-blue-100 dark:border-blue-900/30">核心理念：頻繁進出。強調必須嚴守紀律，否則容易虧損退出市場！</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100">
                            <h5 class="font-black text-blue-700 mb-1">A. 強勢日 (追漲策略)</h5>
                            <p class="text-[11px]">強風/陣風適用。選營收 YOY/成值最強。週 MACD 向上，建議 10:00 後觀察追求延續性。</p>
                            <p class="text-[10px] text-red-500 font-bold mt-1">停損：3日內未脫離成本或虧損5%。</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100">
                            <h5 class="font-black text-blue-700 mb-1">B. 日拉回 (低吸策略)</h5>
                            <p class="text-[11px]">易漲循環適用。拉回 5 日線附近買進，建議分 3 次買進建立成本。</p>
                            <p class="text-[10px] text-red-500 font-bold mt-1">停損：3-5天沒發動或破5日線。</p>
                        </div>
                    </div>
                </section>

                <section class="space-y-3">
                    <h4 class="font-black text-indigo-600 flex items-center gap-2 text-lg"><i data-lucide="briefcase" class="w-5 h-5"></i> 2. 上班族 (Office) — 波段操作</h4>
                    <p class="text-xs bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-xl border border-indigo-100 dark:border-indigo-900/30">核心理念：參與 MACD 趨勢。不需時刻盯盤。</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100">
                            <h5 class="font-black text-indigo-700 mb-1">A. 強勢週 (趨勢策略)</h5>
                            <p class="text-[11px]">強風/陣風。日 MACD 剛翻多 1-2 天，確認週 MACD 向上。建議 11:30 後出手。</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100">
                            <h5 class="font-black text-indigo-700 mb-1">B. 週趨勢 (拉回策略)</h5>
                            <p class="text-[11px]">易漲循環。參與週 MACD 剛翻多 1-2 週，拉回 5 日線附近買下跌。停損週五收盤破上週五。</p>
                        </div>
                    </div>
                </section>

                <section class="space-y-3">
                    <h4 class="font-black text-purple-600 flex items-center gap-2 text-lg"><i data-lucide="crown" class="w-5 h-5"></i> 3. 老闆型 (Boss) — 長期/價值</h4>
                    <p class="text-xs bg-purple-50 dark:bg-purple-900/20 p-3 rounded-xl border border-purple-100 dark:border-purple-900/30">核心理念：買拉回(買綠不買紅)。總資金拆 5 份，單一標的上限制 20%。</p>
                    <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100">
                        <h5 class="font-black text-purple-700 mb-1 underline">週拉回 / 廉價收購 SOP</h5>
                        <p class="text-[11px]">營收 YoY > 30% 且創高。強/亂風分 3-5 批靠近月線買；陣/無風分 10-15 批破月線或靠季線買。</p>
                        <p class="text-[10px] text-red-500 font-bold mt-1">停損：月 MACD 縮短、YoY 轉負、或守季線。</p>
                    </div>
                    <div class="bg-red-600 text-white p-4 rounded-2xl shadow-lg border border-red-400">
                        <p class="font-black text-xs">★ 加碼原則 (必看)：</p>
                        <p class="text-[11px] mt-1 leading-relaxed">若買進第一筆後獲利已達 5%，則不再加碼，避免墊高成本。未來跌回成本下再照策略買進。</p>
                    </div>
                </section>

            </div>
        </div>
    </div>
    <div id="settingsModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md hidden flex items-center justify-center p-4 z-[400]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-sm w-full shadow-2xl animate-in zoom-in duration-300">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center text-slate-600 dark:text-slate-300">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </div>
                <h3 class="text-xl font-black">交易成本設定</h3>
            </div>
            <div class="space-y-5">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">券商手續費折扣 (折數)</label>
                    <div class="relative">
                        <input type="number" inputmode="decimal" id="setting-discount" step="0.1" placeholder="例如 1.7" class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-4 pl-4 pr-12 text-lg font-black focus:ring-2 focus:ring-indigo-500">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-sm font-bold text-slate-400">折</span>
                    </div>
                    <p class="text-[10px] text-slate-400 px-1">標準手續費為 0.1425%，1.7折請填 1.7</p>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">初始投入本金 (元)</label>
                    <div class="relative">
                        <input type="number" inputmode="numeric" id="setting-initial-capital" step="10000" placeholder="例如 500000" class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-4 pl-4 pr-12 text-lg font-black focus:ring-2 focus:ring-indigo-500">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-sm font-bold text-slate-400">$</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">手續費最低低消 (元)</label>
                    <div class="relative">
                        <input type="number" inputmode="numeric" id="setting-min-fee" step="1" placeholder="例如 1" class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-4 pl-4 pr-12 text-lg font-black focus:ring-2 focus:ring-indigo-500">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-sm font-bold text-slate-400">元</span>
                    </div>
                </div>

                <div class="pt-2">
                    <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-indigo-200 dark:shadow-none btn-press flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> 儲存設定
                    </button>
                    <button onclick="closeSettingsModal()" class="w-full text-slate-400 font-bold py-3 mt-2 text-xs uppercase tracking-widest">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc, setDoc, getDoc, serverTimestamp, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB4BuO5gvNfkHYYp48FvwYhK-VXpnb7NSg",
            authDomain: "stock-app-4e8cd.firebaseapp.com",
            projectId: "stock-app-4e8cd",
            storageBucket: "stock-app-4e8cd.firebasestorage.app",
            messagingSenderId: "755625283902",
            appId: "1:755625283902:web:8789da17765e35e5e2dc6f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let trades = [];
        let dailyLogs = {};
        let unsubscribe = null;
        let unsubscribeLogs = null;
        let unsubscribeSession = null;
        let keepAliveInterval = null;
        let chartInstance = null;
        let currentDeviceId = null;
        let visibilityHandler = null;
        
        window.trades = trades;
        // --- 🚀 新增：Google Sheet 連線設定 ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyvQyrjFdchuPKOilwP8pn1MiWiJtmZLRfj4cIGerrZsdw-PIFQGAHZOpmBSJmhbDJvDg/exec";
        window.livePrices = {}; // 存現價：{ "2330": 600 }
        window.stockNames = {}; // 存名稱：{ "2330": "台積電" }

        // 1. 從 Sheet 抓取最新股價
        window.updateStockData = async () => {
            const btn = document.getElementById('refresh-btn-icon');
            if(btn) btn.classList.add('animate-spin');
            
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                
                // 整理資料
                data.forEach(row => {
                    const code = row.symbolCode.toString();
                    if (row.livePrice && row.livePrice !== "#N/A") {
                        window.livePrices[code] = parseFloat(row.livePrice);
                    }
                    if (row.symbolName) {
                        window.stockNames[code] = row.symbolName;
                    }
                });

                console.log("股價已更新", window.livePrices);
                renderPortfolio(); // 更新介面
                updateGlobalStats(); // 更新總損益
            } catch (e) {
                console.error("股價更新失敗", e);
            } finally {
                if(btn) btn.classList.remove('animate-spin');
            }
        };

        // 2. 將新交易同步寫入 Sheet
        window.syncToSheet = (trade) => {
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    symbolCode: trade.symbolCode,
                    symbolName: trade.symbolName,
                    entryPrice: trade.entryPrice,
                    quantity: trade.totalQuantity
                })
            }).then(() => console.log("已同步至 Sheet"));
        };

        // 3. 設定定時器：每 60 秒自動更新一次
        setInterval(window.updateStockData, 60000);
        // =========== 🛑 補上這段：輸入代號自動跳名稱 ===========
        // 等待 1 秒確保網頁載入完成，然後開始監聽
        setTimeout(() => {
            const codeInput = document.getElementById('symbolCode');
            
            if(codeInput) {
                // 當你在「代號」欄位打字時...
                codeInput.addEventListener('input', (e) => {
                    const inputCode = e.target.value; // 你輸入的數字 (例如 2330)
                    
                    // 去檢查我們腦袋裡的名單 (window.stockNames) 有沒有這個號碼
                    if (window.stockNames[inputCode]) {
                        // 有的話，把名稱填入「名稱」欄位
                        document.getElementById('symbolName').value = window.stockNames[inputCode];
                        console.log(`找到股票：${inputCode} ${window.stockNames[inputCode]}`);
                    }
                });
                console.log("自動填入功能已啟動！");
            } else {
                console.error("找不到代號輸入框！");
            }
        }, 1000);
        // ====================================================
        // --- 🚀 結束 ---

        // 生成或獲取設備ID
        function getDeviceId() {
            if (!currentDeviceId) {
                let deviceId = localStorage.getItem('kite_device_id');
                if (!deviceId) {
                    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('kite_device_id', deviceId);
                }
                currentDeviceId = deviceId;
            }
            return currentDeviceId;
        }

        // 更新用戶會話信息
        async function updateUserSession(userId) {
            const deviceId = getDeviceId();
            const sessionRef = doc(db, "users", userId, "session", "current");
            await setDoc(sessionRef, {
                deviceId: deviceId,
                lastActive: serverTimestamp(),
                userAgent: navigator.userAgent,
                platform: navigator.platform
            }, { merge: true });
        }

        // 監聽會話變化，如果其他設備登入則登出當前設備
        function monitorSession(userId) {
            // 清理之前的定時器和事件監聽器
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }
            if (visibilityHandler) {
                document.removeEventListener('visibilitychange', visibilityHandler);
                visibilityHandler = null;
            }

            const sessionRef = doc(db, "users", userId, "session", "current");
            unsubscribeSession = onSnapshot(sessionRef, async (snapshot) => {
                if (snapshot.exists()) {
                    const sessionData = snapshot.data();
                    const currentDeviceId = getDeviceId();
                    
                    // 如果會話中的設備ID與當前設備不同，說明其他設備登入了
                    if (sessionData.deviceId && sessionData.deviceId !== currentDeviceId) {
                        // 清理定時器和事件監聽器
                        if (keepAliveInterval) {
                            clearInterval(keepAliveInterval);
                            keepAliveInterval = null;
                        }
                        if (visibilityHandler) {
                            document.removeEventListener('visibilitychange', visibilityHandler);
                            visibilityHandler = null;
                        }
                        // 強制登出當前設備
                        alert('偵測到您已在其他設備登入，此設備將自動登出。');
                        await signOut(auth);
                        location.reload();
                    }
                }
            }, (error) => {
                console.error("Session monitoring error:", error);
            });

            // 定期更新會話活躍時間（每30秒）
            keepAliveInterval = setInterval(async () => {
                if (currentUser && currentUser.uid === userId) {
                    await updateUserSession(userId);
                } else {
                    if (keepAliveInterval) {
                        clearInterval(keepAliveInterval);
                        keepAliveInterval = null;
                    }
                }
            }, 30000);

            // 頁面可見性變化時也更新會話（只添加一次）
            if (!visibilityHandler) {
                visibilityHandler = async () => {
                    if (!document.hidden && currentUser && currentUser.uid === userId) {
                        await updateUserSession(userId);
                    }
                };
                document.addEventListener('visibilitychange', visibilityHandler);
            }
        }

        // --- 手續費計算核心 ---
        window.getFeeSettings = () => {
            const saved = localStorage.getItem('kite_fee_settings');
            const defaults = { discount: 2.8, minFee: 1, initialCapital: 1000000 };
            
            if (saved) {
                try {
                    const savedSettings = JSON.parse(saved);
                    // 將儲存的設定與預設值合併，確保所有欄位都存在
                    return { ...defaults, ...savedSettings };
                } catch (e) {
                    console.error("讀取設定失敗，使用預設值。", e);
                    return defaults; // 如果解析失敗，回傳預設值
                }
            }
            return defaults; // 如果沒有儲存過，回傳預設值
        };

        window.openSettingsModal = () => {
            const s = window.getFeeSettings();
            document.getElementById('setting-discount').value = s.discount;
            document.getElementById('setting-min-fee').value = s.minFee;
            document.getElementById('setting-initial-capital').value = s.initialCapital || 0;
            document.getElementById('user-menu').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('hidden');
        };

        window.closeSettingsModal = () => document.getElementById('settingsModal').classList.add('hidden');

        window.saveSettings = () => {
            const discount = parseFloat(document.getElementById('setting-discount').value) || 1.7;
            const minFee = parseInt(document.getElementById('setting-min-fee').value) || 1;
            const initialCapital = parseInt(document.getElementById('setting-initial-capital').value) || 0;
            localStorage.setItem('kite_fee_settings', JSON.stringify({ discount, minFee, initialCapital }));
            closeSettingsModal();
            renderHistory();
            updateGlobalStats(); 
            renderStrategyPage();
            alert('費率已更新！所有損益已重新計算。');
        };

        window.calculateCost = (price, qty, type) => {
            const s = window.getFeeSettings();
            const feeRate = 0.001425 * (s.discount / 10); 
            const rawFee = Math.floor(price * qty * feeRate);
            const finalFee = Math.max(s.minFee, rawFee);
            const tax = type === 'sell' ? Math.floor(price * qty * 0.003) : 0;
            return finalFee + tax;
        };

        window.calculateNetPnL = (buyPrice, sellPrice, qty) => {
            const buyCost = (buyPrice * qty) + window.calculateCost(buyPrice, qty, 'buy');
            const sellRevenue = (sellPrice * qty) - window.calculateCost(sellPrice, qty, 'sell');
            return sellRevenue - buyCost;
        };

        // 計算包含手續費的平均成本
        window.calculateAveragePriceWithFee = (price, qty) => {
            const totalCost = (price * qty) + window.calculateCost(price, qty, 'buy');
            return totalCost / qty;
        };

        // 計算多筆交易的平均成本（含手續費）
        window.calculateWeightedAverage = (oldAvgPrice, oldQty, newPrice, newQty) => {
            const oldTotalCost = (oldAvgPrice * oldQty) + window.calculateCost(oldAvgPrice, oldQty, 'buy');
            const newTotalCost = (newPrice * newQty) + window.calculateCost(newPrice, newQty, 'buy');
            const totalQty = oldQty + newQty;
            return (oldTotalCost + newTotalCost) / totalQty;
        };
        // ---------------------------

        window.handleGoogleLogin = async () => {
            const btn = document.getElementById('btn-google');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i> 登入中...`;
            lucide.createIcons();
            try {
                const result = await signInWithPopup(auth, provider);
                // 登入成功後更新會話信息
                if (result.user) {
                    await updateUserSession(result.user.uid);
                }
            } catch (error) {
                console.error("Login Failed:", error);
                alert("登入失敗: " + error.message);
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        };

        window.handleLogout = async () => {
            // 清理會話監聽、定時器和事件監聽器
            if (unsubscribeSession) {
                unsubscribeSession();
                unsubscribeSession = null;
            }
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }
            if (visibilityHandler) {
                document.removeEventListener('visibilitychange', visibilityHandler);
                visibilityHandler = null;
            }
            await signOut(auth);
            location.reload();
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // 更新會話信息（確保會話是最新的）
                await updateUserSession(user.uid);
                
                // 開始監聽會話變化
                monitorSession(user.uid);
                
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.remove('blur-login');
                if(user.photoURL) document.getElementById('user-avatar').src = user.photoURL;
                if(user.displayName) document.getElementById('menu-user-name').textContent = user.displayName;
                subscribeToTrades(user.uid);
                subscribeToDailyLogs(user.uid);
                // 🚀 步驟 4：登入成功，開始抓股價！
                window.updateStockData();
            } else {
                // 清理會話監聽、定時器和事件監聽器
                if (unsubscribeSession) {
                    unsubscribeSession();
                    unsubscribeSession = null;
                }
                if (keepAliveInterval) {
                    clearInterval(keepAliveInterval);
                    keepAliveInterval = null;
                }
                if (visibilityHandler) {
                    document.removeEventListener('visibilitychange', visibilityHandler);
                    visibilityHandler = null;
                }
                
                document.getElementById('login-overlay').classList.remove('hidden');
                document.getElementById('app-content').classList.add('blur-login');
                if(unsubscribe) unsubscribe();
                if(unsubscribeLogs) unsubscribeLogs();
                trades = [];
                dailyLogs = {};
                renderPortfolio();
            }
        });

        function subscribeToTrades(userId) {
            const q = query(collection(db, "users", userId, "trades"), orderBy("createdAt", "desc"));
            unsubscribe = onSnapshot(q, (snapshot) => {
                trades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPortfolio();
                renderHistory();
                updateGlobalStats();
                if(!document.getElementById('page-journal').classList.contains('hidden')) renderCalendar();
            });
        }

        function subscribeToDailyLogs(userId) {
            const q = collection(db, "users", userId, "dailyLogs");
            unsubscribeLogs = onSnapshot(q, (snapshot) => {
                dailyLogs = {};
                snapshot.docs.forEach(doc => {
                    dailyLogs[doc.id] = doc.data();
                });
                if(!document.getElementById('page-journal').classList.contains('hidden')) {
                    renderCalendar();
                    selectDate(window.selectedDate);
                }
            });
        }

        window.handleTradeSubmit = async () => {
            if(!currentUser) return alert("請先登入");
            const idx = document.getElementById('subStrategyInput').value;
            const price = parseFloat(document.getElementById('entryPrice').value);
            const qty = parseInt(document.getElementById('quantity').value);
            
            // 計算包含手續費的平均成本
            const avgPriceWithFee = window.calculateAveragePriceWithFee(price, qty);
            
            const newTrade = {
                persona: window.currentPersona,
                strategyIdx: idx,
                strategyName: personas[window.currentPersona].options[idx].name,
                symbolCode: document.getElementById('symbolCode').value,
                symbolName: document.getElementById('symbolName').value,
                averagePrice: avgPriceWithFee,
                totalQuantity: qty,
                entryPrice: price,
                quantity: qty,
                entryDate: document.getElementById('entryDate').value,
                entryWind: document.getElementById('entryWindInput').value,
                note: document.getElementById('note').value,
                screenshot: window.tempScreenshot || null,
                status: 'open',
                history: [{ type: 'buy', date: document.getElementById('entryDate').value, price, quantity: qty, wind: document.getElementById('entryWindInput').value, note: document.getElementById('note').value, screenshot: window.tempScreenshot || null, timestamp: Date.now() }],
                createdAt: Date.now()
            };

            const btn = document.querySelector('#tradeForm button');
            const oldText = btn.innerHTML;
            btn.innerHTML = '儲存中...';
            try {
                await addDoc(collection(db, "users", currentUser.uid, "trades"), newTrade);
                // 🚀 步驟 3：儲存時同步通知 Google Sheet
                window.syncToSheet(newTrade);
                document.getElementById('tradeForm').reset();
                window.tempScreenshot = null;
                document.getElementById('upload-preview-container').classList.add('hidden');
                document.getElementById('upload-placeholder').classList.remove('hidden');
                document.getElementById('form-container').classList.add('hidden');
                document.querySelectorAll('.persona-card').forEach(c => c.classList.remove('selected'));
                switchTab('portfolio');
            } catch(e) {
                alert("儲存失敗");
                console.error(e);
            } finally {
                btn.innerHTML = oldText;
            }
        };

        window.confirmAddPosition = async () => {
            if(!window.tradeToAddId) return;
            const price = parseFloat(document.getElementById('addPosPrice').value);
            const qty = parseInt(document.getElementById('addPosQty').value);
            const t = trades.find(item => item.id === window.tradeToAddId);
            if (t && price && qty) {
                // 舊的總成本（如果 averagePrice 已含手續費，則直接使用；否則需要加上手續費）
                // 為了安全起見，我們假設 averagePrice 可能已含手續費，所以直接用它計算舊總成本
                const oldTotalCost = t.averagePrice * t.totalQuantity;
                // 新的總成本（含手續費）
                const newTotalCost = (price * qty) + window.calculateCost(price, qty, 'buy');
                const newTotalQty = t.totalQuantity + qty;
                const newAvg = (oldTotalCost + newTotalCost) / newTotalQty;
                const newHistory = [...t.history, { type: 'buy', date: document.getElementById('addPosDate').value, price, quantity: qty, wind: '加碼', note: document.getElementById('addPosNote').value, timestamp: Date.now() }];
                await updateDoc(doc(db, "users", currentUser.uid, "trades", t.id), { totalQuantity: newTotalQty, averagePrice: newAvg, history: newHistory });
                closeAddPositionModal();
            }
        };

        window.confirmSellAction = async () => {
             if(!window.tradeToSellId) return;
             const price = parseFloat(document.getElementById('sellPrice').value);
             const qty = parseInt(document.getElementById('sellQty').value);
             const t = trades.find(item => item.id === window.tradeToSellId);
             if (t && price && qty) {
                const newQty = t.totalQuantity - qty;
                const newHistory = [...t.history, { type: 'sell', date: document.getElementById('sellDate').value, price, quantity: qty, wind: document.getElementById('exitWindInput').value, note: document.getElementById('sellNote').value, timestamp: Date.now() }];
                const updateData = { totalQuantity: newQty, history: newHistory };
                if (newQty <= 0) {
                    updateData.status = 'closed';
                    updateData.exitPrice = price;
                    updateData.exitDate = document.getElementById('sellDate').value;
                    updateData.exitWind = document.getElementById('exitWindInput').value;
                }
                await updateDoc(doc(db, "users", currentUser.uid, "trades", t.id), updateData);
                closeModal();
                if(newQty <= 0) switchTab('history');
             }
        };

        window.confirmAction = async () => {
            if(window.tradeToDeleteId) {
                await deleteDoc(doc(db, "users", currentUser.uid, "trades", window.tradeToDeleteId));
            }
            closeConfirmModal();
        };

        window.currentPersona = '';
        window.tradeToSellId = null;
        window.tradeToAddId = null;
        window.tradeToDeleteId = null;
        window.filterDates = { start: null, end: null };
        window.tempScreenshot = null;
        window.currentYear = new Date().getFullYear();
        window.currentMonth = new Date().getMonth();

        window.getLocalISODate = () => {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        };
        window.selectedDate = window.getLocalISODate();
        
        window.switchTab = (t) => { 
            ['add','portfolio','history','strategy', 'journal'].forEach(p=>{
                document.getElementById(`page-${p}`).classList.add('hidden'); 
                document.getElementById(`tab-${p}`).classList.remove('active'); 
            }); 
            document.getElementById(`page-${t}`).classList.remove('hidden'); 
            document.getElementById(`tab-${t}`).classList.add('active'); 
            if(t==='strategy') renderStrategyPage();
            if(t==='journal') renderJournalPage();
            window.scrollTo(0,0); 
        };
        
        window.toggleUserMenu = () => document.getElementById('user-menu').classList.toggle('hidden');
        window.toggleThemeMenu = () => document.getElementById('theme-menu').classList.toggle('hidden');
        
        // 應用主題的實際邏輯
        window.applyTheme = (theme) => {
            const h = document.documentElement;
            if (theme === 'dark') {
                h.classList.add('dark');
            } else if (theme === 'light') {
                h.classList.remove('dark');
            } else {
                // system mode - 跟隨系統設定
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    h.classList.add('dark');
                } else {
                    h.classList.remove('dark');
                }
            }
        };
        
        // 設置主題並保存
        window.setTheme = (m) => {
            if (m === 'dark') {
                localStorage.setItem('kite_theme', 'dark');
            } else if (m === 'light') {
                localStorage.setItem('kite_theme', 'light');
            } else {
                // system mode
                localStorage.removeItem('kite_theme');
            }
            window.applyTheme(m);
            document.getElementById('theme-menu').classList.add('hidden');
            updateThemeIcons();
        };
        
        // 監聽系統主題變化
        window.setupSystemThemeListener = () => {
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            const handleChange = (e) => {
                const currentTheme = localStorage.getItem('kite_theme') || 'system';
                if (currentTheme === 'system') {
                    window.applyTheme('system');
                }
            };
            // 使用 addEventListener 監聽變化（現代瀏覽器）
            if (mediaQuery.addEventListener) {
                mediaQuery.addEventListener('change', handleChange);
            } else {
                // 舊版瀏覽器使用 addListener
                mediaQuery.addListener(handleChange);
            }
        };
        
        window.updateThemeIcons = () => { 
            document.getElementById('theme-icon-light').classList.add('hidden'); 
            document.getElementById('theme-icon-dark').classList.add('hidden'); 
            document.getElementById('theme-icon-auto').classList.add('hidden'); 
            const s = localStorage.getItem('kite_theme') || 'system'; 
            if (s === 'light') {
                document.getElementById('theme-icon-light').classList.remove('hidden');
            } else if (s === 'dark') {
                document.getElementById('theme-icon-dark').classList.remove('hidden');
            } else {
                document.getElementById('theme-icon-auto').classList.remove('hidden');
            }
        };
        window.showFilterModal = () => document.getElementById('filterModal').classList.remove('hidden');
        window.hideFilterModal = () => document.getElementById('filterModal').classList.add('hidden');
        window.quickSetDate = (type) => { const today = new Date(); let s = new Date(), e = new Date(); if (type === 'thisMonth') { s = new Date(today.getFullYear(), today.getMonth(), 1); } else if (type === 'lastMonth') { s = new Date(today.getFullYear(), today.getMonth() - 1, 1); e = new Date(today.getFullYear(), today.getMonth(), 0); } else if (type === 'thisYear') { s = new Date(today.getFullYear(), 0, 1); } else if (type === 'last30') { s.setDate(today.getDate() - 30); } const fmt = d => d.toISOString().split('T')[0]; document.getElementById('filterStartDate').value = fmt(s); document.getElementById('filterEndDate').value = fmt(e); };
        window.applyDateFilter = () => { window.filterDates.start = document.getElementById('filterStartDate').value; window.filterDates.end = document.getElementById('filterEndDate').value; hideFilterModal(); renderHistory(); updateGlobalStats(); };
        window.resetDateFilter = () => { window.filterDates = {start:null, end:null}; document.getElementById('filterStartDate').value=''; document.getElementById('filterEndDate').value=''; hideFilterModal(); renderHistory(); updateGlobalStats(); };
        window.showWindHelp = () => document.getElementById('windHelpModal').classList.remove('hidden');
        window.hideWindHelp = () => document.getElementById('windHelpModal').classList.add('hidden');
        window.showPersonaHelp = () => document.getElementById('personaHelpModal').classList.remove('hidden');
        window.hidePersonaHelp = () => document.getElementById('personaHelpModal').classList.add('hidden');
        window.closeImageModal = () => document.getElementById('imageModal').classList.add('hidden');
        
        window.openImageModal = (src) => {
            document.getElementById('fullImage').src = src;
            document.getElementById('imageModal').classList.remove('hidden');
        };

        window.selectWind = (phase, w) => { document.querySelectorAll(`#${phase==='entry'?'entryWindContainer':'exitWindContainer'} .wind-card`).forEach(c=>c.classList.remove('selected')); document.querySelector(`#${phase==='entry'?'entryWindContainer':'exitWindContainer'} .wind-card.${w}`).classList.add('selected'); document.getElementById(`${phase==='entry'?'entryWindInput':'exitWindInput'}`).value=w; };
        
        window.selectPersona = (p) => { window.currentPersona=p; document.querySelectorAll('.persona-card').forEach(c=>c.classList.remove('selected')); document.getElementById(`p-${p}`).classList.add('selected'); document.getElementById('form-container').classList.remove('hidden'); document.getElementById('persona-indicator').style.backgroundColor=personas[p].color; const container=document.getElementById('subStrategyContainer'); container.innerHTML = personas[p].options.map((o,i)=>`<div onclick="selectStrategy(${i})" id="strat-${i}" class="cursor-pointer bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-3 rounded-2xl flex items-center gap-2 btn-press"><div class="w-4 h-4 rounded-full border border-slate-300 dark:border-slate-600 flex items-center justify-center strategy-check"><div class="w-2 h-2 rounded-full bg-white opacity-0 strategy-dot"></div></div><span class="font-black text-xs text-slate-600 dark:text-slate-300">${o.name}</span></div>`).join(''); selectStrategy(0); document.getElementById('entryDate').valueAsDate = new Date(); selectWind('entry','強風'); };
        window.selectStrategy = (i) => { document.getElementById('subStrategyInput').value=i; document.querySelectorAll('#subStrategyContainer > div').forEach(c=>{ c.classList.remove('border-indigo-500','bg-indigo-50','dark:bg-indigo-900/20'); c.querySelector('.strategy-check').classList.remove('bg-indigo-600','border-indigo-600'); c.querySelector('.strategy-dot').classList.remove('opacity-100'); }); const s=document.getElementById(`strat-${i}`); if(s){ s.classList.add('border-indigo-500','bg-indigo-50','dark:bg-indigo-900/20'); const c=s.querySelector('.strategy-check'); c.classList.add('bg-indigo-600','border-indigo-600'); c.querySelector('.strategy-dot').classList.add('opacity-100'); updateSubSop(); } };
        window.updateSubSop = () => { const i=document.getElementById('subStrategyInput').value; if(i==="")return; const o=personas[window.currentPersona].options[i]; document.getElementById('persona-summary-text').textContent=o.summary; document.getElementById('rule-sl').textContent=o.sl; document.getElementById('rule-tp').textContent=o.tp; };
        
        window.handleImageUpload = (e) => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{ const img=new Image(); img.src=ev.target.result; img.onload=()=>{ const c=document.createElement('canvas'); const ctx=c.getContext('2d'); const s=800/img.width; const w=(s<1)?800:img.width; const h=(s<1)?img.height*s:img.height; c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h); window.tempScreenshot=c.toDataURL('image/jpeg',0.5); document.getElementById('upload-preview').src=window.tempScreenshot; document.getElementById('upload-placeholder').classList.add('hidden'); document.getElementById('upload-preview-container').classList.remove('hidden'); }}; r.readAsDataURL(f); };
        window.clearImage = (e) => { e.preventDefault(); window.tempScreenshot=null; document.getElementById('tradeScreenshot').value=''; document.getElementById('upload-preview').src=''; document.getElementById('upload-preview-container').classList.add('hidden'); document.getElementById('upload-placeholder').classList.remove('hidden'); };

        window.openSellModal = (id) => { 
            window.tradeToSellId=id; 
            const t=trades.find(item=>item.id===id); 
            document.getElementById('sellModal').classList.remove('hidden'); 
            document.getElementById('sellPrice').value=''; 
            document.getElementById('sellQty').value=t.totalQuantity; 
            document.getElementById('sellQty').max=t.totalQuantity; 
            document.getElementById('sellNote').value=''; 
            document.getElementById('sell-current-qty').textContent=t.totalQuantity.toLocaleString(); 
            document.getElementById('sell-avg-cost').textContent='$'+t.averagePrice.toFixed(2); 
            
            // 計算已付手續費
            let totalFeesPaid = 0;
            t.history.forEach(h => {
                if(h.type === 'buy') {
                    totalFeesPaid += window.calculateCost(h.price, h.quantity, 'buy');
                }
            });
            document.getElementById('sell-paid-fee').textContent='$'+totalFeesPaid.toLocaleString();
            
            document.getElementById('sellDate').valueAsDate=new Date(); 
            document.getElementById('sell-estimate').classList.add('hidden'); 
            selectWind('exit','強風'); 
            updateSellEstimate(); 
        };
        
        window.updateSellEstimate = () => { 
            if(!window.tradeToSellId) return;
            const t = trades.find(item => item.id === window.tradeToSellId);
            const price = parseFloat(document.getElementById('sellPrice').value);
            const qty = parseInt(document.getElementById('sellQty').value);
            const el = document.getElementById('sell-estimate');
            
            if(price && qty && t) {
                const sellFee = window.calculateCost(price, qty, 'sell');
                const netPnL = window.calculateNetPnL(t.averagePrice, price, qty);
                const colorClass = netPnL >= 0 ? 'text-red-500' : 'text-green-600';
                document.getElementById('sell-estimate-val').innerHTML = `
                    <div class="space-y-1.5">
                        <div class="flex justify-between items-center text-[10px] text-slate-500 dark:text-slate-400">
                            <span>賣出手續費+稅:</span>
                            <span class="font-black">$${sellFee.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold ${colorClass} pt-1 border-t border-slate-200 dark:border-slate-700">
                            <span>預估淨損益:</span>
                            <span class="font-black text-base">${netPnL >= 0 ? '+' : ''}$${Math.round(netPnL).toLocaleString()}</span>
                        </div>
                    </div>
                `;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        };

        window.closeModal = () => { document.getElementById('sellModal').classList.add('hidden'); window.tradeToSellId=null; };
        
        window.addPosition = (id) => { window.tradeToAddId=id; document.getElementById('addPositionModal').classList.remove('hidden'); document.getElementById('addPosPrice').value=''; document.getElementById('addPosQty').value=''; document.getElementById('addPosNote').value=''; document.getElementById('addPosDate').valueAsDate=new Date(); };
        window.closeAddPositionModal = () => { document.getElementById('addPositionModal').classList.add('hidden'); window.tradeToAddId=null; };
        
        window.requestDelete = (id) => { window.tradeToDeleteId=id; document.getElementById('confirmModal').classList.remove('hidden'); };
        window.closeConfirmModal = () => { document.getElementById('confirmModal').classList.add('hidden'); window.tradeToDeleteId=null; };
        
        window.viewDetails = (id) => { 
            const t = trades.find(item => item.id === id); 
            if(!t) return; 
            document.getElementById('detail-title').textContent = `${t.symbolCode} ${t.symbolName}`; 
            document.getElementById('detail-subtitle').textContent = `均價 $${t.averagePrice.toFixed(2)} / 持倉 ${t.totalQuantity}股`; 
            const list = document.getElementById('detail-list'); 
            let currentCost = 0, currentQty = 0, avgPrice = 0; 

            // Map with original index to ensure robust editing even if sorted or timestamps missing
            const historyWithIndex = t.history.map((h, i) => ({ ...h, originalIndex: i }));
            const sortedHistory = historyWithIndex.sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));
            
            const htmlItems = sortedHistory.map(h => { 
                let pnlDisplay = ''; 
                let feeDisplay = ''; 
                if(h.type === 'buy') { 
                    // 買入時，總成本包含手續費
                    const buyFee = window.calculateCost(h.price, h.quantity, 'buy');
                    const buyCost = (h.price * h.quantity) + buyFee;
                    currentCost += buyCost; 
                    currentQty += h.quantity; 
                    avgPrice = currentCost / currentQty; 
                    feeDisplay = `<div class="mt-1.5 text-[10px] text-slate-500 dark:text-slate-400"><span class="font-bold">手續費:</span> <span class="font-black">$${buyFee.toLocaleString()}</span></div>`;
                } else if(h.type === 'sell') { 
                    let cost = avgPrice * h.quantity; 
                    const sellFee = window.calculateCost(h.price, h.quantity, 'sell');
                    let realizedPnL = window.calculateNetPnL(avgPrice, h.price, h.quantity); 
                    let pct = cost > 0 ? ((realizedPnL / cost) * 100).toFixed(1) : 0; 
                    const pnlClass = realizedPnL >= 0 ? 'text-red-500' : 'text-green-600'; 
                    feeDisplay = `<div class="mt-1.5 text-[10px] text-slate-500 dark:text-slate-400"><span class="font-bold">手續費+稅:</span> <span class="font-black">$${sellFee.toLocaleString()}</span></div>`;
                    pnlDisplay = `<div class="mt-2 pt-2 border-t dark:border-slate-700 flex justify-between items-center text-xs font-bold ${pnlClass}"><span>淨損益: ${realizedPnL >= 0 ? '+' : ''}$${Math.round(realizedPnL).toLocaleString()} (${pct}%)</span></div>`; 
                    currentCost -= avgPrice * h.quantity; 
                    currentQty -= h.quantity; 
                }
                
                const imageHtml = h.screenshot 
                    ? `<div onclick="openImageModal('${h.screenshot}')" class="mt-2 h-16 w-24 rounded-xl bg-slate-100 dark:bg-slate-800 bg-cover bg-center border border-slate-200 dark:border-slate-700 cursor-pointer relative group overflow-hidden" style="background-image: url('${h.screenshot}')">
                         <div class="absolute inset-0 bg-black/10 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                            <div class="bg-black/50 text-white p-1.5 rounded-full backdrop-blur-md"><i data-lucide="zoom-in" class="w-3 h-3"></i></div>
                         </div>
                       </div>` 
                    : '';

                // Use originalIndex for ID and handlers
                const idx = h.originalIndex;

                return `<div class="p-4 rounded-2xl border ${h.type === 'buy' ? 'bg-indigo-50/50 border-indigo-100 dark:bg-indigo-900/10 dark:border-indigo-900/30' : 'bg-slate-50 border-slate-200 dark:bg-slate-800 dark:border-slate-700'}">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-black uppercase px-2 py-0.5 rounded ${h.type === 'buy' ? 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900 dark:text-indigo-300' : 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300'}">${h.type === 'buy' ? '買進' : '賣出'}</span>
                        <span class="text-[10px] text-slate-400 font-bold">${h.date}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-black text-slate-700 dark:text-slate-200">${h.quantity}股 @ $${h.price}</span>
                        <span class="text-[10px] font-bold text-slate-400">${h.wind || '-'}</span>
                    </div>
                    ${feeDisplay}

                    <div id="note-view-${idx}" class="group relative">
                        <p class="text-sm font-bold text-slate-700 dark:text-slate-300 mt-2 leading-relaxed border-t border-dashed border-slate-200 dark:border-slate-700 pt-2 whitespace-pre-wrap">${window.escapeHtml(h.note) || '<span class="text-slate-400 italic font-normal text-xs">無備註</span>'}</p>
                        <button onclick="toggleEditNote('${t.id}', ${idx})" class="absolute top-2 right-0 p-1 text-slate-300 hover:text-indigo-500 transition-colors"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                    </div>

                    <div id="note-edit-${idx}" class="hidden mt-2 pt-2 border-t border-dashed border-slate-200 dark:border-slate-700">
                        <textarea id="note-input-${idx}" rows="2" class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-2 text-sm font-bold focus:ring-2 focus:ring-indigo-500 mb-2">${h.note || ''}</textarea>
                        <div class="flex justify-end gap-2">
                            <button onclick="toggleEditNote('${t.id}', ${idx})" class="px-3 py-1.5 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">取消</button>
                            <button onclick="saveHistoryNote('${t.id}', ${idx})" class="px-3 py-1.5 rounded-lg text-xs font-bold bg-indigo-600 text-white hover:bg-indigo-700">儲存</button>
                        </div>
                    </div>

                    ${imageHtml}
                    ${pnlDisplay}
                </div>`; 
            }); 
            list.innerHTML = htmlItems.reverse().join(''); 
            lucide.createIcons();
            document.getElementById('detailsModal').classList.remove('hidden'); 
        };
        
        window.closeDetailsModal = () => document.getElementById('detailsModal').classList.add('hidden');

        window.toggleEditNote = (tradeId, idx) => {
            const viewEl = document.getElementById(`note-view-${idx}`);
            const editEl = document.getElementById(`note-edit-${idx}`);
            if(viewEl && editEl) {
                viewEl.classList.toggle('hidden');
                editEl.classList.toggle('hidden');
            }
        };

        window.saveHistoryNote = async (tradeId, idx) => {
            const t = trades.find(item => item.id === tradeId);
            if(!t) return;

            const newContent = document.getElementById(`note-input-${idx}`).value;
            // Directly modify the item at original index
            const newHistory = [...t.history];
            if(newHistory[idx]) {
                newHistory[idx] = { ...newHistory[idx], note: newContent };
            } else {
                return; // Index out of bounds?
            }

            try {
                await updateDoc(doc(db, "users", currentUser.uid, "trades", tradeId), { history: newHistory });

                // Simple DOM update:
                const viewEl = document.getElementById(`note-view-${idx}`);
                const pEl = viewEl.querySelector('p');
                if (newContent) {
                    pEl.textContent = newContent;
                } else {
                    pEl.innerHTML = '<span class="text-slate-400 italic font-normal text-xs">無備註</span>';
                }
                document.getElementById(`note-input-${idx}`).value = newContent;

                window.toggleEditNote(tradeId, idx);
            } catch(e) {
                console.error("Error updating note:", e);
                alert("更新失敗");
            }
        };

        // Journal Logic
        window.renderJournalPage = () => {
            renderCalendar();
            selectDate(window.selectedDate);
        };

        window.renderCalendar = () => {
            const container = document.getElementById('calendar-container');
            const year = window.currentYear;
            const month = window.currentMonth;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];

            let html = `
                <div class="flex items-center justify-between mb-6">
                    <button onclick="prevMonth()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"><i data-lucide="chevron-left" class="w-6 h-6 text-slate-400"></i></button>
                    <h3 class="text-xl font-black text-slate-800 dark:text-slate-100">${year}年 ${monthNames[month]}</h3>
                    <div class="flex gap-2">
                        <button onclick="nextMonth()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"><i data-lucide="chevron-right" class="w-6 h-6 text-slate-400"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-7 gap-1 mb-2">
                    ${['日','一','二','三','四','五','六'].map(d => `<div class="text-center text-[10px] font-black text-slate-400 py-2">${d}</div>`).join('')}
                </div>

                <div class="grid grid-cols-7 gap-1">
            `;

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += `<div></div>`;
            }

            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isSelected = dateStr === window.selectedDate;
                const isToday = dateStr === window.getLocalISODate();
                const hasLog = dailyLogs[dateStr] && dailyLogs[dateStr].content;
                const hasTrade = trades.some(t => t.entryDate === dateStr || t.exitDate === dateStr || t.history.some(h => h.date === dateStr));
                const market = dailyLogs[dateStr]?.marketStatus;

                let bgClass = isSelected ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : (isToday ? 'bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-300');

                // Wind Status Badge
                let marketHtml = '';
                if (market) {
                    const badgeClass = isSelected ? 'bg-white/20 text-white' : `${market.class}`;
                    marketHtml = `<div class="mt-0.5 px-1 py-0.5 rounded-[4px] text-[8px] font-black border border-transparent ${badgeClass} w-full text-center leading-none truncate scale-90">${market.label}</div>`;
                } else {
                     marketHtml = `<div class="mt-0.5 h-3"></div>`;
                }

                html += `
                    <div onclick="selectDate('${dateStr}')" class="aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all btn-press relative ${bgClass} p-1">
                        <span class="text-sm font-black leading-none">${day}</span>
                        ${marketHtml}
                        <div class="flex gap-0.5 mt-0.5">
                            ${hasTrade ? `<div class="w-1 h-1 rounded-full ${isSelected ? 'bg-white' : 'bg-red-500'}"></div>` : ''}
                            ${hasLog ? `<div class="w-1 h-1 rounded-full ${isSelected ? 'bg-white' : 'bg-green-500'}"></div>` : ''}
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            container.innerHTML = html;
            lucide.createIcons();
        };

        window.prevMonth = () => {
            window.currentMonth--;
            if(window.currentMonth < 0) { window.currentMonth = 11; window.currentYear--; }
            renderCalendar();
        };

        window.nextMonth = () => {
            window.currentMonth++;
            if(window.currentMonth > 11) { window.currentMonth = 0; window.currentYear++; }
            renderCalendar();
        };

        window.selectDate = (dateStr) => {
            try {
                window.selectedDate = dateStr;
                renderCalendar(); // Re-render to update selected style

                // Show the main container
                document.getElementById('journal-details-container').classList.remove('hidden');

                // Update Date Title for Log Section
                document.getElementById('journal-date-title').textContent = dateStr.replace(/-/g, '/');

                // Check content
                const log = dailyLogs[dateStr];
                document.getElementById('journal-content').value = log ? log.content : '';

                // --- 🚀 Manual Wind Selection Logic ---
                const windStatusEl = document.getElementById('journal-wind-display');
                if (windStatusEl) windStatusEl.remove(); // Clean up prev

                const logContainer = document.querySelector('#journal-content').parentNode;
                const windDiv = document.createElement('div');
                windDiv.id = 'journal-wind-display';
                windDiv.className = "mb-4";

                const currentWindLabel = log?.marketStatus?.label;
                const isAuto = log?.marketStatus && !log.marketStatus.manual && log.marketStatus.otc;

                // Define wind options
                const windOpts = [
                    { label: '強風', class: 'border-red-500 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400' },
                    { label: '亂流', class: 'border-amber-500 bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400' },
                    { label: '陣風', class: 'border-blue-500 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400' },
                    { label: '無風', class: 'border-slate-400 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400' }
                ];

                let buttonsHtml = windOpts.map(w => {
                    const isActive = currentWindLabel === w.label;
                    const activeClass = isActive ? `ring-2 ring-offset-2 ring-indigo-500 dark:ring-offset-slate-900 ${w.class}` : 'border-transparent bg-slate-50 dark:bg-slate-800 text-slate-400 opacity-60 hover:opacity-100';
                    return `<button onclick="window.setManualWind('${w.label}')" class="flex-1 py-2 rounded-xl text-xs font-black border-2 transition-all ${activeClass}">${w.label}</button>`;
                }).join('');

                let infoHtml = '';
                if(isAuto) {
                    const m = log.marketStatus;
                    infoHtml = `<div class="text-[10px] text-slate-400 text-center mt-2 font-bold flex justify-center gap-3">
                        <span>OTC: ${m.otc.toFixed(1)}</span>
                        <span>MA: ${m.ma20.toFixed(1)}</span>
                        <span>MACD: ${m.macdHist}</span>
                    </div>`;
                }

                windDiv.innerHTML = `<div class="flex gap-2">${buttonsHtml}</div>${infoHtml}`;
                logContainer.insertBefore(windDiv, document.getElementById('journal-content'));
                // --------------------------------------

                // Find activities for this date
                const activities = [];
                trades.forEach(t => {
                    t.history.forEach(h => {
                        if (h.date === dateStr) {
                            activities.push({ ...h, symbolCode: t.symbolCode, symbolName: t.symbolName, tradeId: t.id });
                        }
                    });
                });

                console.log(`Date: ${dateStr}, Activities:`, activities);

                // Update Status Text in Log Section
                const statusText = [];
                if(log) statusText.push(`Last saved: ${log.updatedAt ? new Date(log.updatedAt.seconds * 1000).toLocaleTimeString() : 'Unknown'}`);
                document.getElementById('journal-status').textContent = statusText.length > 0 ? statusText.join('') : '';

                // Update Trade Count
                document.getElementById('journal-trade-count').textContent = `${activities.length} 筆`;

                // Render Trade List
                const listContainer = document.getElementById('journal-trade-list');

                if (activities.length > 0) {
                    listContainer.innerHTML = activities.map(item => {
                        const isBuy = item.type === 'buy';
                        const colorClass = isBuy ? 'text-indigo-600 dark:text-indigo-400' : 'text-red-500';
                        const bgClass = isBuy ? 'bg-indigo-50 dark:bg-indigo-900/20' : 'bg-red-50 dark:bg-red-900/20';
                        const typeText = isBuy ? '買進' : '賣出';

                        return `
                        <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm flex flex-col gap-2 cursor-pointer btn-press transition-colors hover:border-indigo-300 dark:hover:border-indigo-700" onclick="viewDetails('${item.tradeId}')">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-black px-2 py-0.5 rounded ${bgClass} ${colorClass}">${typeText}</span>
                                    <span class="text-sm font-black text-slate-700 dark:text-slate-200">${item.symbolName}</span>
                                    <span class="text-xs font-bold text-slate-400">${item.symbolCode}</span>
                                </div>
                                <span class="text-sm font-black text-slate-800 dark:text-slate-100">$${item.price} <span class="text-slate-300 text-xs">x</span> ${item.quantity}</span>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-800/50">
                                <p class="text-xs font-bold text-slate-600 dark:text-slate-400 whitespace-pre-wrap leading-relaxed">${window.escapeHtml(item.note) || '<span class="text-slate-300 italic font-normal">未填寫交易理由或備註</span>'}</p>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    // Empty State
                    listContainer.innerHTML = `
                        <div class="text-center py-8 bg-slate-50 dark:bg-slate-800/30 rounded-[2rem] border-2 border-dashed border-slate-200 dark:border-slate-800">
                            <div class="w-12 h-12 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm text-slate-300">
                                <i data-lucide="calendar-x" class="w-6 h-6"></i>
                            </div>
                            <p class="text-xs font-black text-slate-400">本日無交易紀錄</p>
                        </div>
                    `;
                }

                // Re-initialize icons for new content
                lucide.createIcons();

            } catch (e) {
                console.error("Error in selectDate:", e);
                alert("載入日期資料時發生錯誤，請重試。");
            }
        };

        window.setManualWind = async (label) => {
            if(!currentUser) return alert("請先登入");
            const dateStr = window.selectedDate;

            // Define static data for manual entry
            const windMap = {
                '強風': { code: 'strong', desc: '手動設定：強風', class: 'text-red-600 bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-900/30' },
                '亂流': { code: 'turbulent', desc: '手動設定：亂流', class: 'text-amber-600 bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-900/30' },
                '陣風': { code: 'gust', desc: '手動設定：陣風', class: 'text-blue-600 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-900/30' },
                '無風': { code: 'none', desc: '手動設定：無風', class: 'text-slate-500 bg-slate-100 dark:bg-slate-800 border-slate-200 dark:border-slate-700' }
            };

            const w = windMap[label];
            if(!w) return;

            // Optimistic Update
            if(!dailyLogs[dateStr]) dailyLogs[dateStr] = {};

            // Capture unsaved text content to prevent data loss on re-render
            const currentContent = document.getElementById('journal-content').value;
            if (currentContent !== undefined) {
                dailyLogs[dateStr].content = currentContent;
            }

            const currentLabel = dailyLogs[dateStr].marketStatus?.label;

            if (currentLabel === label) {
                // Toggle OFF: If clicking the same status, remove it
                delete dailyLogs[dateStr].marketStatus;

                // Refresh UI immediately
                renderCalendar();
                selectDate(dateStr);

                // Delete from DB
                try {
                    await updateDoc(doc(db, "users", currentUser.uid, "dailyLogs", dateStr), {
                        marketStatus: deleteField(),
                        updatedAt: serverTimestamp()
                    });
                    console.log("Manual wind removed:", label);
                } catch(e) {
                    console.error("Failed to remove manual wind", e);
                }

            } else {
                // Set NEW status
                dailyLogs[dateStr].marketStatus = {
                    ...w,
                    label: label,
                    manual: true,
                    otc: 0, ma20: 0, macdHist: 0, prevMacdHist: 0 // Dummy values for manual
                };

                // Refresh UI immediately
                renderCalendar();
                selectDate(dateStr);

                // Save to DB
                try {
                    await setDoc(doc(db, "users", currentUser.uid, "dailyLogs", dateStr), {
                        marketStatus: dailyLogs[dateStr].marketStatus,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    console.log("Manual wind saved:", label);
                } catch(e) {
                    console.error("Failed to save manual wind", e);
                    alert("儲存失敗");
                }
            }
        };

        window.saveDailyLog = async () => {
            if(!currentUser) return alert("請先登入");
            const dateStr = window.selectedDate;
            const content = document.getElementById('journal-content').value;

            // Use specific ID to avoid selecting the wrong button if I added new ones
            const btn = document.querySelector('#journal-details-container button[onclick="saveDailyLog()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> 儲存中...`;
            lucide.createIcons();

            try {
                await setDoc(doc(db, "users", currentUser.uid, "dailyLogs", dateStr), {
                    content: content,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                // Update local cache immediately for better UX
                if(!dailyLogs[dateStr]) dailyLogs[dateStr] = {};
                dailyLogs[dateStr].content = content;

                renderCalendar();
                // Don't re-selectDate here to avoid flickering input focus
                // Just update status text
                const statusText = `Last saved: ${new Date().toLocaleTimeString()}`;
                document.getElementById('journal-status').textContent = statusText;

                // Show success feedback
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> 已儲存`;
                btn.classList.add('bg-green-600');
                lucide.createIcons();
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-600');
                    lucide.createIcons();
                }, 2000);
            } catch (e) {
                console.error("Error saving log:", e);
                alert("儲存失敗");
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        };

        // Strategy Logic
        window.renderStrategyPage = () => {
            const closedTrades = trades.filter(t => t.status === 'closed');
            
            const personaStats = { freelancer: 0, office: 0, boss: 0 };
            const windStats = { 強風: 0, 亂流: 0, 陣風: 0, 無風: 0 };
            const comboStats = {};
            
            closedTrades.forEach(t => {
                let pnl = 0;
                let exitWind = t.exitWind || '無風';
                t.history.forEach(h => { if(h.type === 'sell') pnl += window.calculateNetPnL(t.averagePrice, h.price, h.quantity); });
                
                if (personaStats[t.persona] !== undefined) personaStats[t.persona] += pnl;
                if (windStats[exitWind] !== undefined) windStats[exitWind] += pnl;
                
                const comboKey = `${t.persona}-${exitWind}`;
                if (!comboStats[comboKey]) comboStats[comboKey] = 0;
                comboStats[comboKey] += pnl;
            });

            const bestPersona = Object.entries(personaStats).reduce((a, b) => a[1] > b[1] ? a : b, ['無', -Infinity]);
            const bestWind = Object.entries(windStats).reduce((a, b) => a[1] > b[1] ? a : b, ['無', -Infinity]);
            const worstCombo = Object.entries(comboStats).reduce((a, b) => a[1] < b[1] ? a : b, ['無', Infinity]);
            
            const personaTitles = { freelancer: '打工型', office: '上班族', boss: '老闆型', '無': '尚未交易' };

            document.getElementById('best-persona').textContent = personaTitles[bestPersona[0]] || '尚未交易';
            document.getElementById('best-wind').textContent = bestWind[0] || '無';
            
            if (worstCombo[0] !== '無' && worstCombo[1] < 0) {
                const [p, w] = worstCombo[0].split('-');
                document.getElementById('worst-combo').textContent = `${personaTitles[p]} + ${w}`;
                document.getElementById('worst-combo-desc').textContent = `此組合虧損達 $${Math.abs(Math.round(worstCombo[1])).toLocaleString()}，建議避免。`;
            } else {
                document.getElementById('worst-combo').textContent = "表現優良";
                document.getElementById('worst-combo-desc').textContent = "暫無顯著虧損組合。";
            }

            renderStrategyMatrix(closedTrades);
            renderEquityChart();
        };

        function renderStrategyMatrix(closedTrades) {
            const matrix = document.getElementById('strategy-matrix');
            const winds = ['強風', '亂流', '陣風', '無風'];
            const personasList = ['freelancer', 'office', 'boss'];
            
            let html = `<div class="bg-transparent"></div>`;
            winds.forEach(w => html += `<div class="text-[10px] text-center font-black text-slate-400 uppercase tracking-widest py-2">${w}</div>`);
            
            personasList.forEach(p => {
                html += `<div class="flex flex-col items-center justify-center gap-1.5">
                    <div class="w-8 h-8 rounded-xl flex items-center justify-center text-white text-xs" style="background-color: ${personas[p].color}">
                        <i data-lucide="${getPersonaIcon(p)}" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[10px] font-black text-slate-600 dark:text-slate-300">${personas[p].title}</span>
                </div>`;
                
                winds.forEach(w => {
                    const tradesInCell = closedTrades.filter(t => t.persona === p && t.exitWind === w);
                    let cellPnl = 0;
                    let winCount = 0;
                    tradesInCell.forEach(t => {
                        let pnl = 0;
                        t.history.forEach(h => { if(h.type === 'sell') pnl += window.calculateNetPnL(t.averagePrice, h.price, h.quantity); });
                        cellPnl += pnl;
                        if(pnl > 0) winCount++;
                    });
                    
                    const winRate = tradesInCell.length > 0 ? Math.round((winCount / tradesInCell.length) * 100) : 0;
                    const bgClass = cellPnl > 0 ? 'bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300' : (cellPnl < 0 ? 'bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-300' : 'bg-slate-50 dark:bg-slate-800 text-slate-300');
                    
                    html += `
                        <div class="matrix-cell ${bgClass} rounded-xl p-2 flex flex-col items-center justify-center min-h-[60px]">
                            <span class="text-[10px] font-bold">${winRate}%</span>
                            <span class="text-xs font-black">${formatLargeNumber(cellPnl)}</span>
                        </div>
                    `;
                });
            });
            
            matrix.innerHTML = html;
            lucide.createIcons();
        }

        function getPersonaIcon(p) {
            if(p === 'freelancer') return 'zap';
            if(p === 'office') return 'briefcase';
            return 'crown';
        }

        function renderEquityChart() {
            const ctx = document.getElementById('equityChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const allHistory = [];
            trades.forEach(t => {
                t.history.forEach(h => {
                    if (h.type === 'sell') {
                        const pnl = window.calculateNetPnL(t.averagePrice, h.price, h.quantity);
                        allHistory.push({ date: h.date, pnl: pnl });
                    }
                });
            });
            
            allHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let accumulated = 0;
            const labels = [];
            const dataPoints = [];
            
            allHistory.forEach(h => {
                accumulated += h.pnl;
                labels.push(h.date.substring(5));
                dataPoints.push(accumulated);
            });
            
            if (dataPoints.length === 0) { labels.push('Start'); dataPoints.push(0); }

            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#334155' : '#e2e8f0';
            const textColor = isDark ? '#94a3b8' : '#64748b';

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '累計淨損益',
                        data: dataPoints,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: textColor, maxTicksLimit: 6 } },
                        y: { grid: { color: gridColor, borderDash: [4, 4] }, ticks: { color: textColor, callback: function(value) { return '$' + formatLargeNumber(value); } } }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
        }

        const personas = {
    freelancer: {
        title: '打工型',
        color: '#3b82f6',
        options: [
            { 
                name: '強勢日(追漲策略)', 
                summary: '核心：頻繁進出。重點：選營收YOY或成值最強標的，第一/二根紅K，週MACD向上，建議10:00後觀察。', 
                sl: '1. 買進3日內未脫離成本(-1~2%)\n2. 虧損達5%', 
                tp: '1. 獲利10%以上(放出風箏)\n2. 收盤跌破5日/10日線' 
            },
            { 
                name: '日拉回(低吸策略)', 
                summary: '核心：飆股休息。重點：拉回5日線附近買進。建議分3次買進建立成本。', 
                sl: '1. 3~5天沒發動下一波攻勢\n2. 跌破5日線', 
                tp: '1. 獲利10%以上\n2. 收盤跌破5日/10日線' 
            }
        ]
    },
    office: {
        title: '上班族',
        color: '#6366f1',
        options: [
            { 
                name: '強勢週(趨勢策略)', 
                summary: '核心：MACD趨勢。重點：參與日MACD剛翻多1-2天，確認週MACD向上。建議11:30後出手。', 
                sl: '1. 買進4日內未脫離成本(-1~3%)\n2. 收盤跌破5日線', 
                tp: '1. 獲利10%以上\n2. 收盤跌破5日/10日線' 
            },
            { 
                name: '週趨勢(拉回策略)', 
                summary: '核心：易漲循環。重點：參與週MACD剛翻多1-2週，拉回5日線買下跌。', 
                sl: '1. 當週五收盤低於上週五\n2. 跌破10日線', 
                tp: '1. 獲利10%以上\n2. 週MACD紅柱縮短(週五)\n3. 跌破5週線(5MA)' 
            }
        ]
    },
    boss: {
        title: '老闆型',
        color: '#a855f7',
        options: [
            { 
                name: '週拉回 / 廉價收購', 
                summary: '重點：營收YoY>30%且創高。強風/亂流分3-5批靠近月線買；陣/無風分10-15批破月線買。', 
                sl: '1. 月MACD紅柱縮短\n2. 營收YoY轉負\n3. 守季線', 
                tp: '1. 週K站不回5週線\n2. 週五收盤比上週五低' 
            }
        ]
    }
};        const windColors={'強風':'bg-red-500','亂流':'bg-amber-500','陣風':'bg-blue-500','無風':'bg-slate-400'};
        function formatLargeNumber(n){const a=Math.abs(n);if(a>=1000000000000)return(a/1000000000000).toFixed(2)+'兆';if(a>=100000000)return(a/100000000).toFixed(2)+'億';if(a>=10000)return(a/10000).toFixed(1)+'萬';return Math.round(a).toLocaleString();}
        window.escapeHtml = (text) => {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        // --- 🚀 風度系統 (Wind Status System) ---
        window.calculateWindStatus = (otc, ma20, macdHist, prevMacdHist) => {
            // 1. Determine Cycle (Good vs Bad) based on OTC vs 20MA
            const isGoodCycle = otc >= ma20;
            const isMacdGrowing = macdHist > prevMacdHist;

            if (isGoodCycle) {
                if (isMacdGrowing) {
                    // OTC >= 20MA && MACD > Prev -> 強風
                    return { code: 'strong', label: '強風', desc: '行情：強風 (勝率偏高)', class: 'text-red-600 bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-900/30' };
                } else {
                    // OTC >= 20MA && MACD < Prev -> 亂流
                    return { code: 'turbulent', label: '亂流', desc: '行情：亂流 (震盪/嚴守紀律)', class: 'text-amber-600 bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-900/30' };
                }
            } else {
                if (isMacdGrowing) {
                    // OTC < 20MA && MACD > Prev -> 陣風
                    return { code: 'gust', label: '陣風', desc: '行情：陣風 (嘗試交易)', class: 'text-blue-600 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-900/30' };
                } else {
                    // OTC < 20MA && MACD < Prev -> 無風
                    return { code: 'none', label: '無風', desc: '行情：無風 (多做多賠)', class: 'text-slate-500 bg-slate-100 dark:bg-slate-800 border-slate-200 dark:border-slate-700' };
                }
            }
        };

        window.fetchMarketData = async () => {
            try {
                const res = await fetch(GAS_URL + "?action=getMarketStatus");
                const data = await res.json();

                if (data.error) {
                    console.error("無法取得市場數據:", data.error);
                    return null;
                }

                // 確保回傳正確的數據結構
                if (data.otc === undefined || data.ma20 === undefined) {
                    console.error("市場數據格式錯誤:", data);
                    return null;
                }

                return {
                    otc: Number(data.otc),
                    ma20: Number(data.ma20),
                    macdHist: Number(data.macdHist),
                    prevMacdHist: Number(data.prevMacdHist)
                };
            } catch (e) {
                console.error("連線失敗:", e);
                return null;
            }
        };

        window.updateWindStatus = async (force = false) => {
             if(!currentUser) return;

             const today = window.getLocalISODate();

             // 如果今天已經有數據且不強制更新，就跳過
             if (!force && dailyLogs[today] && dailyLogs[today].marketStatus) {
                 console.log("今日風度已存在:", dailyLogs[today].marketStatus);
                 return;
             }

             const btn = document.querySelector('button[onclick="window.updateWindStatus(true)"]');
             if(btn) btn.classList.add('animate-spin');

             try {
                 console.log("正在抓取風度數據...");
                 const data = await window.fetchMarketData();
                 if (!data) throw new Error("無效的市場數據");

                 const status = window.calculateWindStatus(data.otc, data.ma20, data.macdHist, data.prevMacdHist);

                 const statusData = {
                     otc: data.otc,
                     ma20: data.ma20,
                     macdHist: data.macdHist,
                     prevMacdHist: data.prevMacdHist,
                     ...status,
                     updatedAt: Date.now()
                 };

                 await setDoc(doc(db, "users", currentUser.uid, "dailyLogs", today), {
                     marketStatus: statusData
                 }, { merge: true });

                 console.log("風度更新完成:", statusData);

                 // Update Local
                 if(!dailyLogs[today]) dailyLogs[today] = {};
                 dailyLogs[today].marketStatus = statusData;

                 renderCalendar();
                 if(window.selectedDate === today) selectDate(today);

             } catch(e) {
                 console.error("風度更新失敗", e);
             } finally {
                 if(btn) btn.classList.remove('animate-spin');
             }
        };

        // Initialize UI
        const savedTheme = localStorage.getItem('kite_theme') || 'system';
        setTheme(savedTheme);
        setupSystemThemeListener(); // 設置系統主題變化監聽
        lucide.createIcons();

        // Render Functions
        window.renderPortfolio = () => {
            const list = document.getElementById('portfolio-list'); 
            const openTrades = trades.filter(t => t.status === 'open').sort((a, b) => b.createdAt - a.createdAt);
            
            // 取得當前時間
            const now = new Date();
            const updateTimeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });

            // 重新整理按鈕
            const refreshHeader = `
                <div class="col-span-full flex justify-end mb-2">
                    <button onclick="updateStockData()" class="flex items-center gap-1 text-[10px] font-bold bg-white dark:bg-slate-900 px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-800 shadow-sm active:scale-95 transition-all text-slate-500">
                        <i data-lucide="refresh-cw" class="w-3 h-3" id="refresh-btn-icon"></i>
                        <span>更新報價</span>
                    </button>
                </div>`;

            if (openTrades.length === 0) { 
                list.innerHTML = refreshHeader + `<div class="col-span-full text-center py-12 text-slate-300 font-bold text-xs border-2 border-dashed rounded-3xl border-slate-100 dark:border-slate-800">無持倉</div>`; 
                lucide.createIcons();
                return; 
            }

            const cardsHtml = openTrades.map(t => {
                const hasImg = t.history.some(h => h.screenshot);
                const imgIcon = hasImg ? `<i data-lucide="image" class="w-3.5 h-3.5 text-indigo-400"></i>` : '';
                
                const entryDateObj = new Date(t.entryDate);
                const daysHeld = Math.floor((new Date() - entryDateObj) / (1000 * 60 * 60 * 24));
                
                // === 修改處：顯示完整年月日 (YYYY/MM/DD) ===
                const entryDateDisplay = t.entryDate.replace(/-/g, '/'); 
                
                const livePrice = window.livePrices[t.symbolCode] || t.averagePrice;
                const isLive = !!window.livePrices[t.symbolCode]; 
                const marketValue = livePrice * t.totalQuantity;
                const costValue = t.averagePrice * t.totalQuantity; 
                // 扣除預估賣出成本 (手續費 + 交易稅)
                const sellCost = window.calculateCost(livePrice, t.totalQuantity, 'sell');
                const unPnl = marketValue - costValue - sellCost;
                const roi = costValue > 0 ? ((unPnl / costValue) * 100).toFixed(2) : 0;
                
                const pnlClass = unPnl >= 0 ? 'text-red-500' : 'text-green-500';
                const bgClass = unPnl >= 0 ? 'bg-red-50 dark:bg-red-900/10' : 'bg-green-50 dark:bg-green-900/10';

                return `<div class="bg-white dark:bg-slate-900 p-5 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-800 btn-press relative overflow-hidden" onclick="viewDetails('${t.id}')">
                    
                    <div class="absolute right-0 top-0 bottom-0 w-24 ${bgClass} opacity-50 blur-2xl pointer-events-none"></div>

                    <div class="flex justify-between items-start relative z-10 mb-2">
                        <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[9px] font-black px-1.5 py-0.5 rounded text-white shadow-sm" style="background-color: ${personas[t.persona].color}">${personas[t.persona].title}</span>
                                <span class="text-[9px] font-black px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400">${t.strategyName}</span>
                            </div>
                            
                            <div class="flex items-baseline gap-1.5">
                                <h3 class="text-xl font-black text-slate-800 dark:text-slate-100 leading-none">${t.symbolName}</h3>
                                <span class="text-sm font-bold text-slate-400">${t.symbolCode}</span>
                                ${imgIcon}
                            </div>

                            <div class="flex items-center gap-1 mt-0.5">
                                <i data-lucide="clock" class="w-3 h-3 text-slate-300"></i>
                                <p class="text-[10px] font-bold text-slate-400">${entryDateDisplay} (${daysHeld}天)</p>
                            </div>
                        </div>

                        <div class="text-right">
                            <p class="text-2xl font-black ${pnlClass} tracking-tight">${unPnl >= 0 ? '+' : ''}${Math.round(unPnl).toLocaleString()}</p>
                            <p class="text-xs font-bold ${pnlClass} mb-1">${roi}%</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-end border-t border-slate-50 dark:border-slate-800/50 pt-3 relative z-10">
                        <div class="text-left">
                            <p class="text-[10px] text-slate-300 dark:text-slate-600 font-bold uppercase">成本 / 股數</p>
                            <p class="text-xs font-black text-slate-600 dark:text-slate-400">$${t.averagePrice.toFixed(1)} <span class="text-slate-300">|</span> ${t.totalQuantity}股</p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center justify-end gap-1">
                                <p class="text-[9px] text-slate-300 dark:text-slate-600 font-bold">${updateTimeStr} 更新</p>
                                ${isLive ? '<span class="relative flex h-1.5 w-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-red-500"></span></span>' : ''}
                            </div>
                            <p class="text-sm font-black text-slate-800 dark:text-slate-200">現價 $${livePrice}</p>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-3 pt-2" onclick="event.stopPropagation()">
                        <button onclick="addPosition('${t.id}')" class="flex-1 bg-slate-50 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 dark:bg-slate-800 dark:text-slate-400 px-3 py-2.5 rounded-xl flex items-center justify-center gap-1 transition-colors"><i data-lucide="plus" class="w-3.5 h-3.5"></i><span class="text-[10px] font-black">加碼</span></button>
                        <button onclick="openSellModal('${t.id}')" class="flex-1 bg-slate-50 hover:bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400 px-3 py-2.5 rounded-xl flex items-center justify-center gap-1 transition-colors"><i data-lucide="log-out" class="w-3.5 h-3.5"></i><span class="text-[10px] font-black">平倉</span></button>
                        
                        <button onclick="requestDelete('${t.id}')" class="bg-red-50 hover:bg-red-100 text-red-500 dark:bg-red-900/20 dark:text-red-400 px-3 py-2.5 rounded-xl flex items-center justify-center transition-colors border border-transparent hover:border-red-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`;
            }).join('');
            
            list.innerHTML = refreshHeader + cardsHtml;
            lucide.createIcons();
        };
        window.renderHistory = () => {
            const list = document.getElementById('history-list');
            const stats = document.getElementById('history-stats');
            
            const closedTrades = trades.filter(t => t.status === 'closed').sort((a, b) => {
                const getLastSellTime = (trade) => {
                    const lastSell = [...trade.history].reverse().find(h => h.type === 'sell');
                    if (lastSell && lastSell.timestamp) return lastSell.timestamp;
                    if (trade.exitDate) return new Date(trade.exitDate).getTime();
                    return 0;
                };
                return getLastSellTime(b) - getLastSellTime(a);
            });

            if (closedTrades.length === 0) {
                list.innerHTML = `<div class="text-center py-12 text-slate-300 font-bold text-xs border-2 border-dashed rounded-3xl border-slate-100 dark:border-slate-800">尚無歷史交易</div>`;
                if (stats) stats.innerHTML = '';
                return;
            }

            list.innerHTML = closedTrades.map(t => {
                let totalPnL = 0;
                let totalFees = 0;
                let totalCost = 0; 

                t.history.forEach(h => {
                    if(h.type === 'sell') {
                        totalPnL += window.calculateNetPnL(t.averagePrice, h.price, h.quantity);
                        totalFees += window.calculateCost(h.price, h.quantity, 'sell');
                        totalCost += (t.averagePrice * h.quantity);
                    } else if(h.type === 'buy') {
                        totalFees += window.calculateCost(h.price, h.quantity, 'buy');
                    }
                });

                const roi = totalCost > 0 ? ((totalPnL / totalCost) * 100).toFixed(1) : 0;
                const sign = totalPnL >= 0 ? '+' : '-';
                const exitDateStr = t.exitDate || t.history[t.history.length - 1]?.date || '';
                
                const start = new Date(t.entryDate);
                const end = new Date(exitDateStr);
                const daysHeld = Math.max(1, Math.floor((end - start) / (1000 * 60 * 60 * 24)));
                
                // === 修改處：顯示完整年月日 (YYYY/MM/DD) ===
                const dateDisplay = t.entryDate.replace(/-/g, '/');

                const pnlClass = totalPnL >= 0 ? 'text-red-500' : 'text-green-600';
                const borderClass = totalPnL >= 0 ? 'border-l-4 border-l-red-500' : 'border-l-4 border-l-green-500';
                
                return `<div class="bg-white dark:bg-slate-900 px-5 py-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 ${borderClass} btn-press flex justify-between items-center group relative" onclick="viewDetails('${t.id}')">
                    
                    <div class="flex flex-col gap-1.5">
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">${dateDisplay}</span>
                            <span class="text-[9px] font-black px-1.5 py-0.5 rounded text-white" style="background-color: ${personas[t.persona].color}">${personas[t.persona].title}</span>
                        </div>
                        
                        <div class="flex items-baseline gap-1.5">
                            <h3 class="text-base font-black text-slate-800 dark:text-slate-100">${t.symbolName}</h3>
                            <span class="text-xs font-bold text-slate-400">${t.symbolCode}</span>
                        </div>
                        
                        <div class="flex items-center gap-2 text-[10px] text-slate-400 font-bold">
                            <span class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-slate-500 dark:text-slate-400 flex items-center gap-1"><i data-lucide="hourglass" class="w-2.5 h-2.5"></i> ${daysHeld}天</span>
                            <span>費 $${totalFees.toLocaleString()}</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <p class="text-lg xs:text-xl font-black ${pnlClass}">
                                ${sign}$${formatLargeNumber(totalPnL)}
                                <span class="text-xs font-bold ml-0.5">(${roi}%)</span>
                            </p>
                            <p class="text-[10px] font-bold text-slate-300 dark:text-slate-600">已實現淨利</p>
                        </div>
                        
                        <button onclick="event.stopPropagation(); requestDelete('${t.id}')" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full transition-all">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>

                </div>`;
            }).join('');
            
            lucide.createIcons();
        };
        // ✅ 貼上這段新的 (包含彈窗開關 + 詳細費用計算)
window.showStatsModal = () => document.getElementById('statsModal').classList.remove('hidden');
        window.closeStatsModal = () => document.getElementById('statsModal').classList.add('hidden');

        window.updateGlobalStats = () => {
            let tPL = 0, tCost = 0;
            let allTimePL = 0; // 用於計算現金流的全時段損益
            let totalBuyFee = 0, totalSellFee = 0, totalTax = 0;
            let winCount = 0, closedCount = 0;
            
            // --- 新增：未實現損益計算變數 ---
            let tUnrealized = 0;
            let tOpenCost = 0;
            const s = window.getFeeSettings();
            const feeRate = 0.001425 * (s.discount / 10);

            trades.forEach(t => {
                t.history.forEach(h => {
                    if(h.type === 'sell'){
                        const pnl = window.calculateNetPnL(t.averagePrice, h.price, h.quantity);
                        
                        // 1. 累計全時段損益 (算現金用)
                        allTimePL += pnl;

                        // 2. 累計篩選區間損益 (顯示用)
                        if(window.filterDates.start && window.filterDates.end && (h.date < window.filterDates.start || h.date > window.filterDates.end)) return;
                        
                        // 計算費用細項
                        const bFee = Math.max(s.minFee, Math.floor(t.entryPrice * h.quantity * feeRate));
                        const sFee = Math.max(s.minFee, Math.floor(h.price * h.quantity * feeRate));
                        const tax = Math.floor(h.price * h.quantity * 0.003);
                        totalBuyFee += bFee; totalSellFee += sFee; totalTax += tax;

                        // 計算損益
                        let cost = (t.averagePrice * h.quantity);
                        tPL += pnl; tCost += cost;
                        if(pnl > 0) winCount++; closedCount++;
                    }
                });

                // 2. 計算未實現 (Unrealized) - 針對持倉中
                if (t.status === 'open') {
                    const currentPrice = window.livePrices[t.symbolCode] || t.averagePrice;
                    const marketVal = currentPrice * t.totalQuantity;
                    const costVal = t.averagePrice * t.totalQuantity;
                    // 扣除預估賣出成本
                    const sellCost = window.calculateCost(currentPrice, t.totalQuantity, 'sell');
                    tUnrealized += (marketVal - costVal - sellCost);
                    tOpenCost += costVal;
                }
            });

            // 計算資產數據
            const initialCapital = s.initialCapital || 0;
            const availableCash = initialCapital + allTimePL - tOpenCost; // 本金 + 歷史總賺賠 - 目前卡在股票裡的錢
            const marketValue = tOpenCost + tUnrealized; // 持倉成本 + 未實現損益
            const totalAssets = availableCash + marketValue;

            // 更新 Header 卡片數據
            const totalAssetsEl = document.getElementById('header-total-assets');
            if(totalAssetsEl) totalAssetsEl.textContent = `$${formatLargeNumber(totalAssets)}`;
            
            const initCapEl = document.getElementById('header-initial-capital');
            if(initCapEl) initCapEl.textContent = `$${formatLargeNumber(initialCapital)}`;

            const mktValEl = document.getElementById('header-market-value');
            if(mktValEl) mktValEl.textContent = `$${formatLargeNumber(marketValue)}`;

            const cashEl = document.getElementById('header-available-cash');
            if(cashEl) cashEl.textContent = `$${formatLargeNumber(availableCash)}`;

            // 更新 Header - 已實現損益 (受篩選影響)
            const plEl = document.getElementById('header-total-pl'); 
            if(plEl){ plEl.textContent = `${tPL >= 0 ? '+' : ''}$${formatLargeNumber(tPL)}`; plEl.className = `text-base font-black ${tPL >= 0 ? 'text-red-500' : 'text-green-600'}`; }
            
            // 更新 Header - 未實現損益
            const unPlEl = document.getElementById('header-unrealized-pl');
            const unPctEl = document.getElementById('header-unrealized-pct');
            if(unPlEl) {
                unPlEl.textContent = `${tUnrealized >= 0 ? '+' : ''}$${formatLargeNumber(tUnrealized)}`;
                unPlEl.className = `text-base font-black ${tUnrealized >= 0 ? 'text-red-500' : 'text-green-600'}`;
            }
            if(unPctEl) {
                let unRoi = tOpenCost > 0 ? ((tUnrealized / tOpenCost) * 100).toFixed(1) : 0.0;
                unPctEl.textContent = `${unRoi >= 0 ? '+' : ''}${unRoi}%`;
                unPctEl.className = `text-[10px] font-bold ${unRoi >= 0 ? 'text-red-400' : 'text-green-500'}`;
            }

            // 更新彈窗數據 (把算好的費用填進去)
            const winStr = closedCount > 0 ? ((winCount / closedCount) * 100).toFixed(0) + '%' : '0%';
            const totalFees = totalBuyFee + totalSellFee;
            document.getElementById('modal-net-pnl').textContent = `${tPL >= 0 ? '+' : ''}$${formatLargeNumber(tPL)}`;
            document.getElementById('modal-net-pnl').className = `text-3xl font-black ${tPL >= 0 ? 'text-red-500' : 'text-green-600'}`;
            document.getElementById('modal-total-fee').textContent = `$${formatLargeNumber(totalFees)}`;
            document.getElementById('modal-total-tax').textContent = `$${formatLargeNumber(totalTax)}`;
            document.getElementById('modal-win-rate').textContent = winStr;
        };    </script>
   <div id="statsModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md hidden flex items-center justify-center p-4 z-[400]" onclick="closeStatsModal()">
    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-sm w-full shadow-2xl animate-in zoom-in duration-300" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between mb-6 border-b border-slate-100 dark:border-slate-800 pb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white">
                    <i data-lucide="pie-chart" class="w-5 h-5"></i>
                </div>
                <div>
                    <h3 class="text-lg font-black">損益分析</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">P&L Breakdown</p>
                </div>
            </div>
            <button onclick="closeStatsModal()" class="text-slate-400 bg-slate-50 dark:bg-slate-800 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="space-y-4">
            <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-3xl text-center">
                <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">淨損益 (Net P&L)</p>
                <p id="modal-net-pnl" class="text-3xl font-black">--</p>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-amber-50 dark:bg-amber-900/10 p-3 rounded-2xl border border-amber-100 dark:border-amber-900/30">
                    <div class="flex items-center gap-2 mb-1"><i data-lucide="coins" class="w-3 h-3 text-amber-500"></i><p class="text-[10px] font-black text-amber-600 dark:text-amber-400 uppercase">總手續費</p></div>
                    <p id="modal-total-fee" class="text-lg font-black text-amber-700 dark:text-amber-500">--</p>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/10 p-3 rounded-2xl border border-blue-100 dark:border-blue-900/30">
                    <div class="flex items-center gap-2 mb-1"><i data-lucide="landmark" class="w-3 h-3 text-blue-500"></i><p class="text-[10px] font-black text-blue-600 dark:text-blue-400 uppercase">總證交稅</p></div>
                    <p id="modal-total-tax" class="text-lg font-black text-blue-700 dark:text-blue-500">--</p>
                </div>
            </div>
            <div class="p-3 rounded-2xl border border-dashed border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-500">交易勝率</span>
                <span id="modal-win-rate" class="text-base font-black">--</span>
            </div>
        </div>
    </div>
</div> 
</body>
</html>
