<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>風箏選股交易紀錄系統 (Cloud v1.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        indigo: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81', 950: '#1e1b4b', }
                    },
                    screens: { 'xs': '375px' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto+Sans+TC', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; touch-action: manipulation; overscroll-behavior-y: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; min-height: 100dvh; padding-bottom: env(safe-area-inset-bottom); }
        input, textarea { -webkit-user-select: text; user-select: text; font-size: 16px !important; }
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        .persona-card, .wind-card { cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .persona-card.selected { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        #p-freelancer.selected { border-color: #3b82f6; background-color: #eff6ff; }
        #p-office.selected { border-color: #6366f1; background-color: #eef2ff; }
        #p-boss.selected { border-color: #a855f7; background-color: #faf5ff; }
        .dark #p-freelancer.selected { background-color: rgba(59, 130, 246, 0.15); border-color: #60a5fa; }
        .dark #p-office.selected { background-color: rgba(99, 102, 241, 0.15); border-color: #818cf8; }
        .dark #p-boss.selected { background-color: rgba(168, 85, 247, 0.15); border-color: #c084fc; }
        .wind-card.selected.強風 { border-color: #ef4444; background-color: #fef2f2; }
        .wind-card.selected.亂流 { border-color: #f59e0b; background-color: #fffbeb; }
        .wind-card.selected.陣風 { border-color: #3b82f6; background-color: #eff6ff; }
        .wind-card.selected.無風 { border-color: #94a3b8; background-color: #f8fafc; }
        .dark .wind-card.selected.強風 { background-color: rgba(239, 68, 68, 0.15); border-color: #f87171; }
        .dark .wind-card.selected.亂流 { background-color: rgba(245, 158, 11, 0.15); border-color: #fbbf24; }
        .dark .wind-card.selected.陣風 { background-color: rgba(59, 130, 246, 0.15); border-color: #60a5fa; }
        .dark .wind-card.selected.無風 { background-color: rgba(148, 163, 184, 0.15); border-color: #94a3b8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .smooth-scroll { -webkit-overflow-scrolling: touch; }
        .tab-button.active { background-color: white; color: #4f46e5; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .dark .tab-button.active { background-color: #312e81; color: #e0e7ff; }
        .blur-login { filter: blur(8px); pointer-events: none; user-select: none; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .matrix-cell { transition: all 0.2s; }
        .modal-content { max-height: 85dvh; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: slideDown 0.2s ease-in-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-[100dvh] pb-safe bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 relative overflow-x-hidden">

    <div id="login-overlay" class="fixed inset-0 z-[500] flex flex-col items-center justify-center p-6 bg-slate-50/90 dark:bg-slate-950/90 backdrop-blur-md transition-all duration-500 h-[100dvh]">
        <div class="w-full max-w-sm bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-2xl p-8 border border-slate-100 dark:border-slate-800 animate-in fade-in zoom-in duration-300">
            <div class="flex flex-col items-center text-center mb-8">
                <div class="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center text-white shadow-xl shadow-indigo-500/30 mb-6">
                    <i data-lucide="cloud" class="w-10 h-10"></i>
                </div>
                <h1 class="text-3xl font-black mb-2">KITE 雲端版</h1>
                <p class="text-sm text-slate-400 font-bold uppercase tracking-widest">Cloud Sync Active</p>
            </div>
            <div class="space-y-4">
                <button onclick="handleGoogleLogin()" id="btn-google" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-white font-bold py-5 rounded-2xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-all flex items-center justify-center gap-3 shadow-sm group text-lg btn-press">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    Google 帳號登入
                </button>
                <div class="text-center">
                    <p class="text-[10px] text-slate-400 font-bold">登入後資料將自動同步至雲端</p>
                </div>
            </div>
        </div>
    </div>

    <div id="app-content" class="max-w-5xl mx-auto px-4 py-4 transition-all duration-500 blur-login pb-24">
        <header class="mb-5">
            <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 xs:w-12 xs:h-12 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/20"><i data-lucide="wind" class="w-6 h-6"></i></div>
                        <div><h1 class="text-2xl xs:text-3xl font-black tracking-tight">KITE 日誌</h1><p class="text-[10px] xs:text-xs text-slate-400 dark:text-slate-500 font-bold uppercase tracking-widest flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Cloud Online</p></div>
                    </div>
                    <div class="flex items-center gap-2 relative">
                        <div class="relative">
                            <button onclick="toggleUserMenu()" class="flex items-center gap-2 bg-white dark:bg-slate-900 rounded-2xl pl-1 pr-3 py-1.5 border border-slate-200 dark:border-slate-800 shadow-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition-all btn-press" id="user-btn">
                                <img id="user-avatar" src="" class="w-8 h-8 rounded-xl bg-slate-200 object-cover">
                                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 ml-1"></i>
                            </button>
                            <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-2xl shadow-xl z-[150] overflow-hidden">
                                <div class="px-5 py-4 border-b border-slate-50 dark:border-slate-800">
                                    <p class="text-xs font-bold text-slate-400 uppercase">帳號</p>
                                    <p class="text-sm font-black truncate" id="menu-user-name">Loading...</p>
                                </div>
                                <button onclick="handleLogout()" class="w-full px-5 py-4 text-left text-sm font-bold text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-3"><i data-lucide="log-out" class="w-4 h-4"></i> 登出帳號</button>
                            </div>
                        </div>
                        <div class="relative">
                            <button onclick="toggleThemeMenu()" id="theme-toggle-btn" class="w-11 h-11 flex items-center justify-center rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-sm transition-all hover:bg-slate-100 dark:hover:bg-slate-800 btn-press">
                                <i data-lucide="sun" id="theme-icon-light" class="w-5 h-5 text-amber-500 hidden"></i><i data-lucide="moon" id="theme-icon-dark" class="w-5 h-5 text-indigo-400 hidden"></i><i data-lucide="monitor" id="theme-icon-auto" class="w-5 h-5 text-slate-400 hidden"></i>
                            </button>
                            <div id="theme-menu" class="hidden absolute right-0 mt-2 w-40 bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-2xl shadow-xl z-[150] overflow-hidden">
                                <button onclick="setTheme('light')" class="w-full px-5 py-3 text-left text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center gap-3"><i data-lucide="sun" class="w-4 h-4 text-amber-500"></i> 晝間模式</button>
                                <button onclick="setTheme('dark')" class="w-full px-5 py-3 text-left text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center gap-3"><i data-lucide="moon" class="w-4 h-4 text-indigo-400"></i> 夜間模式</button>
                                <button onclick="setTheme('system')" class="w-full px-5 py-3 text-left text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center gap-3 border-t dark:border-slate-800"><i data-lucide="monitor" class="w-4 h-4 text-slate-400"></i> 跟隨系統</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto no-scrollbar smooth-scroll -mx-4 px-4 pb-1">
                    <div class="glass-card bg-white dark:bg-slate-900 p-4 rounded-[2rem] shadow-xl shadow-slate-200/40 dark:shadow-none border border-transparent dark:border-slate-800 flex items-center justify-between min-w-[320px]">
                        <div class="flex-1 text-center border-r border-slate-100 dark:border-slate-800 relative group px-1">
                            <div class="flex items-center justify-center gap-1 mb-1"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">實現損益</p><button onclick="showFilterModal()" class="text-slate-300 dark:text-slate-600 hover:text-indigo-600 transition-colors p-1 -m-1"><i data-lucide="calendar-search" class="w-3 h-3"></i></button></div>
                            <div class="flex flex-col items-center"><span id="header-total-pl" class="text-base xs:text-lg font-black leading-tight">--</span><span id="header-total-pct" class="text-[10px] font-bold mt-1">--</span></div>
                        </div>
                        <div class="flex-1 text-center border-r border-slate-100 dark:border-slate-800 px-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">庫存</p>
                            <div class="flex flex-col items-center"><span id="header-portfolio-count" class="text-base xs:text-lg font-black leading-tight text-indigo-600 dark:text-indigo-400">--</span><span class="text-[10px] text-slate-300 dark:text-slate-600 font-bold mt-1 uppercase tracking-tighter">隻</span></div>
                        </div>
                        <div class="flex-1 text-center px-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">勝率</p>
                            <div class="flex flex-col items-center"><span id="header-win-rate" class="text-base xs:text-lg font-black leading-tight">--</span><div class="flex flex-col items-center"><span id="filter-all-label" class="text-[10px] text-slate-300 dark:text-slate-600 font-bold mt-1 uppercase tracking-tighter">全時段</span><span id="filter-active-range" class="text-[9px] text-indigo-500 dark:text-indigo-300 font-bold mt-1 hidden bg-indigo-50 dark:bg-indigo-950/50 px-2 py-0.5 rounded-full">篩選中</span></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <nav class="bg-slate-200/50 dark:bg-slate-900/50 p-1.5 rounded-2xl flex mb-6 shadow-inner overflow-x-auto no-scrollbar smooth-scroll sticky top-0 z-40 backdrop-blur-md">
            <button onclick="switchTab('add')" id="tab-add" class="tab-button active flex-1 py-3 px-3 xs:px-4 rounded-xl text-xs xs:text-sm font-black transition-all flex items-center justify-center gap-1.5 min-w-[80px] whitespace-nowrap btn-press">新增</button>
            <button onclick="switchTab('portfolio')" id="tab-portfolio" class="tab-button flex-1 py-3 px-3 xs:px-4 rounded-xl text-xs xs:text-sm font-black text-slate-500 transition-all flex items-center justify-center gap-1.5 min-w-[80px] whitespace-nowrap btn-press">庫存</button>
            <button onclick="switchTab('history')" id="tab-history" class="tab-button flex-1 py-3 px-3 xs:px-4 rounded-xl text-xs xs:text-sm font-black text-slate-500 transition-all flex items-center justify-center gap-1.5 min-w-[80px] whitespace-nowrap btn-press">歷史</button>
            <button onclick="switchTab('strategy')" id="tab-strategy" class="tab-button flex-1 py-3 px-3 xs:px-4 rounded-xl text-xs xs:text-sm font-black text-slate-500 transition-all flex items-center justify-center gap-1.5 min-w-[80px] whitespace-nowrap btn-press"><i data-lucide="layout-grid" class="w-3.5 h-3.5"></i> 戰情</button>
        </nav>

        <div id="page-add" class="space-y-5 animate-in">
            <div class="flex items-center gap-3 mb-2 ml-1"><h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">選擇操作人格</h2><button type="button" onclick="showPersonaHelp()" class="text-slate-300 hover:text-indigo-500 p-2 -m-2"><i data-lucide="info" class="w-5 h-5"></i></button></div>
            <div class="grid grid-cols-3 gap-2 xs:gap-3">
                <div onclick="selectPersona('freelancer')" id="p-freelancer" class="persona-card group bg-white dark:bg-slate-900 p-2 xs:p-3 md:p-5 rounded-2xl xs:rounded-3xl border-2 border-transparent shadow-sm text-center hover:shadow-md dark:shadow-none transition-all btn-press"><div class="w-10 h-10 xs:w-12 xs:h-12 bg-blue-50 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center text-blue-600 dark:text-blue-400 mx-auto mb-2 xs:mb-3"><i data-lucide="zap" class="w-5 h-5 xs:w-6 xs:h-6"></i></div><h3 class="font-black text-xs xs:text-sm">打工型</h3></div>
                <div onclick="selectPersona('office')" id="p-office" class="persona-card group bg-white dark:bg-slate-900 p-2 xs:p-3 md:p-5 rounded-2xl xs:rounded-3xl border-2 border-transparent shadow-sm text-center hover:shadow-md dark:shadow-none transition-all btn-press"><div class="w-10 h-10 xs:w-12 xs:h-12 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center text-indigo-600 dark:text-indigo-400 mx-auto mb-2 xs:mb-3"><i data-lucide="briefcase" class="w-5 h-5 xs:w-6 xs:h-6"></i></div><h3 class="font-black text-xs xs:text-sm">上班族</h3></div>
                <div onclick="selectPersona('boss')" id="p-boss" class="persona-card group bg-white dark:bg-slate-900 p-2 xs:p-3 md:p-5 rounded-2xl xs:rounded-3xl border-2 border-transparent shadow-sm text-center hover:shadow-md dark:shadow-none transition-all btn-press"><div class="w-10 h-10 xs:w-12 xs:h-12 bg-purple-50 dark:bg-purple-900/30 rounded-2xl flex items-center justify-center text-purple-600 dark:text-purple-400 mx-auto mb-2 xs:mb-3"><i data-lucide="crown" class="w-5 h-5 xs:w-6 xs:h-6"></i></div><h3 class="font-black text-xs xs:text-sm">老闆型</h3></div>
            </div>
            <div id="form-container" class="hidden">
                <div class="bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl shadow-indigo-100 dark:shadow-none p-5 md:p-8 border border-slate-50 dark:border-slate-800 overflow-hidden relative">
                    <div id="persona-indicator" class="absolute top-0 left-0 w-1.5 h-full bg-indigo-600"></div>
                    <form id="tradeForm" class="space-y-6">
                        <div class="flex flex-col gap-4 border-b dark:border-slate-800 pb-5">
                            <div class="flex justify-between items-start">
                                <div><h2 class="text-lg xs:text-xl font-black">進場紀錄填寫</h2><p class="text-[10px] xs:text-xs text-slate-400 font-bold uppercase tracking-wider mt-1 leading-tight" id="persona-summary-text"></p></div>
                                <div id="sop-badge" class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-tighter shrink-0 ml-2">GUIDED</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="space-y-2">
                                <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">具體策略分支</label>
                                <div id="subStrategyContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                                <input type="hidden" id="subStrategyInput">
                            </div>
                            <div class="bg-indigo-50/50 dark:bg-slate-800/50 rounded-2xl p-4 border border-indigo-100 dark:border-slate-700/50 relative overflow-hidden">
                                <div class="flex items-center gap-2 mb-3"><div class="w-5 h-5 bg-indigo-600 rounded-full flex items-center justify-center text-white"><i data-lucide="check" class="w-3 h-3"></i></div><h4 class="text-xs font-black text-indigo-900 dark:text-indigo-300">戰略確認</h4></div>
                                <div class="grid grid-cols-1 gap-3 text-sm relative z-10">
                                    <div class="bg-white/60 dark:bg-slate-900/60 p-3 rounded-xl border border-red-100 dark:border-red-900/20">
                                        <span class="font-black text-red-500 dark:text-red-400 uppercase tracking-wider block mb-1 flex items-center gap-1 text-[10px]"><i data-lucide="alert-circle" class="w-3 h-3"></i> 停損機制</span>
                                        <p id="rule-sl" class="font-bold text-slate-700 dark:text-slate-300 leading-relaxed text-xs whitespace-pre-line">...</p>
                                    </div>
                                    <div class="bg-white/60 dark:bg-slate-900/60 p-3 rounded-xl border border-green-100 dark:border-green-900/20">
                                        <span class="font-black text-green-600 dark:text-green-400 uppercase tracking-wider block mb-1 flex items-center gap-1 text-[10px]"><i data-lucide="target" class="w-3 h-3"></i> 停利目標</span>
                                        <p id="rule-tp" class="font-bold text-slate-700 dark:text-slate-300 leading-relaxed text-xs whitespace-pre-line">...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">代號</label><input type="number" inputmode="numeric" id="symbolCode" placeholder="2330" required class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold"></div>
                                <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">名稱</label><input type="text" id="symbolName" placeholder="台積電" required class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">單價</label><input type="number" inputmode="decimal" id="entryPrice" step="0.01" required class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold"></div>
                                <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">股數</label><input type="number" inputmode="numeric" id="quantity" step="1" required class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold"></div>
                            </div>
                            <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">技術圖</label><div class="relative"><input type="file" id="tradeScreenshot" accept="image/*" class="hidden" onchange="handleImageUpload(event)"><label for="tradeScreenshot" class="cursor-pointer w-full bg-slate-50 dark:bg-slate-800 border-2 border-dashed border-slate-200 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-500 rounded-2xl p-3.5 flex items-center justify-center gap-3 transition-colors group btn-press"><div id="upload-placeholder" class="flex items-center gap-2 text-slate-400 group-hover:text-indigo-500"><i data-lucide="image-plus" class="w-5 h-5"></i><span class="text-sm font-bold">上傳/拍攝</span></div><div id="upload-preview-container" class="hidden flex items-center gap-3 w-full"><img id="upload-preview" src="" class="h-10 w-10 object-cover rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm"><span class="text-sm font-bold text-green-600 dark:text-green-400 flex-1">Ready</span><span class="text-xs text-slate-400 underline font-bold hover:text-red-500 p-2" onclick="clearImage(event)">重選</span></div></label></div></div>
                            <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">日期</label><input type="date" id="entryDate" required class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold appearance-none"></div>
                            
                            <div class="space-y-2"><div class="flex items-center gap-1 ml-1"><label class="text-xs font-black text-slate-400 uppercase tracking-widest">環境風度</label><button type="button" onclick="showWindHelp()" class="text-slate-300 hover:text-indigo-500"><i data-lucide="info" class="w-4 h-4"></i></button></div><div class="grid grid-cols-4 gap-2" id="entryWindContainer"><div onclick="selectWind('entry', '強風')" data-wind="強風" class="wind-card 強風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center btn-press"><p class="text-xs font-black">強風</p></div><div onclick="selectWind('entry', '亂流')" data-wind="亂流" class="wind-card 亂流 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center btn-press"><p class="text-xs font-black">亂流</p></div><div onclick="selectWind('entry', '陣風')" data-wind="陣風" class="wind-card 陣風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center btn-press"><p class="text-xs font-black">陣風</p></div><div onclick="selectWind('entry', '無風')" data-wind="無風" class="wind-card 無風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center btn-press"><p class="text-xs font-black">無風</p></div></div><input type="hidden" id="entryWindInput" value="強風"></div>
                            
                            <div class="space-y-1.5"><label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">筆記</label><textarea id="note" rows="2" placeholder="備註..." class="w-full bg-slate-50 dark:bg-slate-800 border-0 rounded-2xl p-3.5 text-base focus:ring-2 focus:ring-indigo-500 font-bold"></textarea></div>
                        </div>
                        <button type="button" onclick="handleTradeSubmit()" class="w-full bg-slate-950 dark:bg-indigo-600 text-white text-base font-black py-4 rounded-2xl hover:bg-indigo-700 dark:hover:bg-indigo-500 transition-all shadow-xl shadow-indigo-100 dark:shadow-none flex items-center justify-center gap-3 mt-4 btn-press"><i data-lucide="save" class="w-5 h-5"></i> 儲存交易</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="page-portfolio" class="hidden space-y-5 animate-in"><div id="portfolio-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20"></div></div>
        <div id="page-history" class="hidden space-y-5 animate-in"><div id="history-stats" class="grid grid-cols-2 gap-4"></div><div id="history-list" class="space-y-4 pb-20"></div></div>
        
        <div id="page-strategy" class="hidden space-y-6 animate-in pb-20">
            <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 dark:from-indigo-900 dark:to-slate-900 rounded-[2rem] p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-6 opacity-10"><i data-lucide="crosshair" class="w-24 h-24"></i></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="bg-white/20 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">Strategy Insight</span>
                    </div>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div><p class="text-indigo-200 text-[10px] font-bold uppercase mb-1">MVP 人格</p><h3 id="best-persona" class="text-2xl font-black">計算中...</h3></div>
                            <div><p class="text-indigo-200 text-[10px] font-bold uppercase mb-1">黃金風度</p><h3 id="best-wind" class="text-2xl font-black">計算中...</h3></div>
                        </div>
                        <div class="bg-red-500/20 rounded-2xl p-3 border border-red-500/30">
                            <p class="text-red-200 text-[10px] font-bold uppercase mb-1 flex items-center gap-1"><i data-lucide="skull" class="w-3 h-3"></i> 毒藥警示</p>
                            <h3 id="worst-combo" class="text-lg font-black text-white">計算中...</h3>
                            <p id="worst-combo-desc" class="text-red-200 text-[10px] mt-1 leading-relaxed">...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-900 rounded-[2rem] p-4 shadow-sm border border-slate-50 dark:border-slate-800">
                <div class="flex items-center justify-between mb-4 px-1">
                    <h3 class="text-base font-black text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4 text-indigo-500"></i> 資金權益曲線</h3>
                </div>
                <div class="relative w-full h-56">
                    <canvas id="equityChart" class="w-full h-full"></canvas>
                </div>
            </div>

            <div>
                <div class="flex items-center justify-between mb-3 px-1">
                    <h3 class="text-base font-black text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="grid" class="w-4 h-4 text-indigo-500"></i> 獲利矩陣</h3>
                    <p class="text-[10px] text-slate-400 font-bold">往右滑動查看更多 →</p>
                </div>
                <div class="relative">
                    <div class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-slate-50 dark:from-slate-950 to-transparent pointer-events-none z-10"></div>
                    <div class="overflow-x-auto no-scrollbar smooth-scroll pb-2 -mx-4 px-4">
                        <div class="min-w-[500px] grid grid-cols-5 gap-2" id="strategy-matrix"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-slate-950/70 backdrop-blur-md hidden flex items-center justify-center p-6 z-[300]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-8 max-w-xs w-full shadow-2xl animate-in zoom-in duration-300 text-center border border-slate-100 dark:border-slate-800">
            <div class="w-16 h-16 bg-red-50 dark:bg-red-900/20 rounded-3xl flex items-center justify-center text-red-500 mx-auto mb-4"><i data-lucide="alert-triangle" class="w-8 h-8"></i></div>
            <h3 class="text-xl font-black mb-2">確認刪除？</h3><p class="text-xs text-slate-500 font-bold mb-6">此動作無法復原。</p>
            <div class="flex gap-3"><button onclick="confirmAction()" class="flex-1 bg-red-500 text-white font-black py-3.5 rounded-2xl text-sm btn-press">確認</button><button onclick="closeConfirmModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold py-3.5 rounded-2xl text-sm btn-press">取消</button></div>
        </div>
    </div>

    <div id="detailsModal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden flex items-center justify-center p-4 z-[250]" onclick="closeDetailsModal()">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-lg w-full shadow-2xl animate-in zoom-in duration-300 max-h-[85dvh] flex flex-col modal-content overflow-y-auto no-scrollbar" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4 pb-4 border-b dark:border-slate-800">
                <div><h3 class="text-xl font-black" id="detail-title">交易明細</h3><p class="text-xs text-slate-400 font-bold mt-1" id="detail-subtitle">--</p></div>
                <button onclick="closeDetailsModal()" class="text-slate-400 bg-slate-100 dark:bg-slate-800 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="detail-list" class="space-y-3 pb-safe"></div>
        </div>
    </div>

    <div id="imageModal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-md hidden flex items-center justify-center p-4 z-[300]" onclick="closeImageModal()">
        <div class="relative w-full h-full flex items-center justify-center" onclick="event.stopPropagation()">
            <img id="fullImage" src="" class="max-w-full max-h-full rounded-lg shadow-2xl object-contain">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 bg-slate-800/80 text-white p-3 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>

    <div id="addPositionModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-sm w-full shadow-2xl animate-in zoom-in duration-300 overflow-y-auto no-scrollbar max-h-[90dvh]">
            <div class="flex items-center gap-3 mb-6 text-indigo-600"><div class="w-10 h-10 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl flex items-center justify-center"><i data-lucide="trending-up" class="w-5 h-5"></i></div><h3 class="text-xl font-black text-slate-900 dark:text-slate-100">倉位加碼</h3></div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">加碼價格</label><input type="number" inputmode="decimal" id="addPosPrice" step="0.01" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-indigo-500 font-black text-base"></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">加碼股數</label><input type="number" inputmode="numeric" id="addPosQty" step="1" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-indigo-500 font-black text-base"></div>
                </div>
                <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">加碼日期</label><input type="date" id="addPosDate" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-indigo-500 font-black text-base appearance-none"></div>
                <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">理由</label><textarea id="addPosNote" rows="2" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-indigo-500 font-bold text-base" placeholder="為何加碼？"></textarea></div>
                <div class="flex gap-3 pt-2"><button onclick="confirmAddPosition()" class="flex-[2] bg-indigo-600 text-white font-black py-4 rounded-2xl text-base btn-press">確認</button><button onclick="closeAddPositionModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold py-4 rounded-2xl text-base btn-press">取消</button></div>
            </div>
        </div>
    </div>

    <div id="sellModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-sm w-full shadow-2xl animate-in zoom-in duration-300 overflow-y-auto no-scrollbar max-h-[90dvh]">
            <div class="flex items-center gap-3 mb-6 text-red-500"><div class="w-10 h-10 bg-red-50 dark:bg-red-900/20 rounded-2xl flex items-center justify-center"><i data-lucide="log-out" class="w-5 h-5"></i></div><h3 class="text-xl font-black text-slate-900 dark:text-slate-100">平倉/減碼</h3></div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3 mb-1">
                    <div class="bg-slate-50 dark:bg-slate-800 rounded-2xl p-3 text-center"><p class="text-[9px] text-slate-400 uppercase font-bold">持倉</p><p class="text-xl font-black text-slate-700 dark:text-slate-200" id="sell-current-qty">0</p></div>
                    <div class="bg-slate-50 dark:bg-slate-800 rounded-2xl p-3 text-center"><p class="text-[9px] text-slate-400 uppercase font-bold">成本</p><p class="text-xl font-black text-slate-700 dark:text-slate-200" id="sell-avg-cost">0</p></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">賣出價格</label><input type="number" inputmode="decimal" id="sellPrice" step="0.01" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-red-500 font-black text-base" oninput="updateSellEstimate()"></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">賣出股數</label><input type="number" inputmode="numeric" id="sellQty" step="1" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-red-500 font-black text-base" oninput="updateSellEstimate()"></div>
                </div>
                <div id="sell-estimate" class="hidden bg-slate-50 dark:bg-slate-800/50 p-3 rounded-2xl border border-slate-100 dark:border-slate-700 text-center"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1">預估損益</p><p class="text-base font-black" id="sell-estimate-val">--</p></div>
                <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">賣出日期</label><input type="date" id="sellDate" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-red-500 font-black text-base appearance-none"></div>
                <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">賣出理由</label><textarea id="sellNote" rows="2" class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-2xl p-3.5 focus:ring-2 focus:ring-red-500 font-bold text-base" placeholder="為何賣出？"></textarea></div>
                <div class="space-y-2">
                    <div class="flex items-center gap-1 ml-1"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">當下風度</label></div>
                    <div class="grid grid-cols-4 gap-2" id="exitWindContainer">
                        <div onclick="selectWind('exit', '強風')" data-wind="強風" class="wind-card 強風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center text-xs font-bold btn-press">強風</div>
                        <div onclick="selectWind('exit', '亂流')" data-wind="亂流" class="wind-card 亂流 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center text-xs font-bold btn-press">亂流</div>
                        <div onclick="selectWind('exit', '陣風')" data-wind="陣風" class="wind-card 陣風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center text-xs font-bold btn-press">陣風</div>
                        <div onclick="selectWind('exit', '無風')" data-wind="無風" class="wind-card 無風 bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-2 rounded-2xl text-center text-xs font-bold btn-press">無風</div>
                    </div>
                    <input type="hidden" id="exitWindInput" value="強風">
                </div>
                <div class="flex gap-3 pt-2"><button onclick="confirmSellAction()" class="flex-[2] bg-slate-900 dark:bg-indigo-600 text-white font-black py-4 rounded-2xl hover:bg-red-600 transition shadow-lg shadow-slate-200 dark:shadow-none text-base btn-press">賣出</button><button onclick="closeModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold py-4 rounded-2xl text-base btn-press">取消</button></div>
            </div>
        </div>
    </div>

    <div id="filterModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md hidden flex items-center justify-center p-4 z-[200]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-sm w-full shadow-2xl animate-in zoom-in duration-300">
            <div class="flex items-center gap-3 mb-6"><div class="w-10 h-10 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center text-indigo-600 dark:text-indigo-400"><i data-lucide="calendar-range" class="w-5 h-5"></i></div><h3 class="text-xl font-black">區間查詢</h3></div>
            <div class="space-y-4">
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="quickSetDate('thisMonth')" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black py-3 rounded-2xl btn-press flex flex-col items-center gap-1"><i data-lucide="calendar" class="w-4 h-4"></i><span class="text-[10px]">本月</span></button>
                    <button onclick="quickSetDate('lastMonth')" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black py-3 rounded-2xl btn-press flex flex-col items-center gap-1"><i data-lucide="calendar-minus" class="w-4 h-4"></i><span class="text-[10px]">上月</span></button>
                    <button onclick="quickSetDate('thisYear')" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black py-3 rounded-2xl btn-press flex flex-col items-center gap-1"><i data-lucide="calendar-range" class="w-4 h-4"></i><span class="text-[10px]">今年</span></button>
                    <button onclick="quickSetDate('last30')" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black py-3 rounded-2xl btn-press flex flex-col items-center gap-1"><i data-lucide="hourglass" class="w-4 h-4"></i><span class="text-[10px]">近30天</span></button>
                </div>
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-3xl border border-slate-100 dark:border-slate-800/50 flex items-center gap-2">
                    <div class="flex-1"><label class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">From</label><input type="date" id="filterStartDate" class="w-full bg-transparent border-0 p-0 font-black text-slate-700 dark:text-slate-200 text-sm focus:ring-0"></div>
                    <div class="text-slate-300 dark:text-slate-600"><i data-lucide="arrow-right" class="w-4 h-4"></i></div>
                    <div class="flex-1 text-right"><label class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">To</label><input type="date" id="filterEndDate" class="w-full bg-transparent border-0 p-0 font-black text-slate-700 dark:text-slate-200 text-sm focus:ring-0 text-right"></div>
                </div>
                <div class="flex gap-3 pt-2"><button onclick="applyDateFilter()" class="flex-[2] bg-indigo-600 text-white font-bold py-3.5 rounded-2xl text-sm btn-press">套用篩選</button><button onclick="resetDateFilter()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold py-3.5 rounded-2xl text-sm btn-press">重設</button></div>
                <button onclick="hideFilterModal()" class="w-full text-slate-400 text-xs font-bold uppercase tracking-widest py-2">取消</button>
            </div>
        </div>
    </div>

    <div id="windHelpModal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden flex items-center justify-center p-4 z-[300]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 max-w-md w-full shadow-2xl animate-in zoom-in duration-300 max-h-[85dvh] flex flex-col modal-content overflow-y-auto no-scrollbar">
            <div class="flex items-center justify-between mb-4 pb-2 border-b dark:border-slate-800"><h3 class="text-xl font-black">風度圖規則</h3><button onclick="hideWindHelp()" class="text-slate-300 p-2"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="space-y-3 pb-safe">
                 <div class="p-4 rounded-3xl bg-red-50 dark:bg-red-950/20 border border-red-100 dark:border-red-900/30"><div class="flex items-center gap-3 mb-2"><div class="w-10 h-10 shrink-0 bg-red-500 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-lg shadow-red-500/30">強風</div><div><p class="font-black text-red-600 dark:text-red-400 text-base">勝率偏高</p><p class="text-[10px] text-red-400 dark:text-red-300 font-bold">適合：積極操作</p></div></div><p class="text-[11px] text-slate-600 dark:text-slate-300 leading-relaxed font-medium">櫃買 >= 20MA 且 MACD紅柱放大。</p></div>
                 <div class="p-4 rounded-3xl bg-amber-50 dark:bg-amber-950/20 border border-amber-100 dark:border-amber-900/30"><div class="flex items-center gap-3 mb-2"><div class="w-10 h-10 shrink-0 bg-amber-500 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-lg shadow-amber-500/30">亂流</div><div><p class="font-black text-amber-600 dark:text-amber-400 text-base">震盪整理</p><p class="text-[10px] text-amber-500 dark:text-amber-300 font-bold">適合：停利/縮手</p></div></div><p class="text-[11px] text-slate-600 dark:text-slate-300 leading-relaxed font-medium">櫃買 >= 20MA 但 MACD紅柱縮短。</p></div>
                 <div class="p-4 rounded-3xl bg-blue-50 dark:bg-blue-950/20 border border-blue-100 dark:border-blue-900/30"><div class="flex items-center gap-3 mb-2"><div class="w-10 h-10 shrink-0 bg-blue-500 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-lg shadow-blue-500/30">陣風</div><div><p class="font-black text-blue-600 dark:text-blue-400 text-base">空頭反彈</p><p class="text-[10px] text-blue-400 dark:text-blue-300 font-bold">適合：短打/觀察</p></div></div><p class="text-[11px] text-slate-600 dark:text-slate-300 leading-relaxed font-medium">櫃買 < 20MA 但 MACD綠柱縮短。</p></div>
                 <div class="p-4 rounded-3xl bg-slate-100 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700"><div class="flex items-center gap-3 mb-2"><div class="w-10 h-10 shrink-0 bg-slate-400 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-lg shadow-slate-400/30">無風</div><div><p class="font-black text-slate-600 dark:text-slate-400 text-base">多做多賠</p><p class="text-[10px] text-slate-400 dark:text-slate-500 font-bold">適合：空手休息</p></div></div><p class="text-[11px] text-slate-600 dark:text-slate-300 leading-relaxed font-medium">櫃買 < 20MA 且 MACD綠柱放大。</p></div>
            </div>
        </div>
    </div>
    
    <div id="personaHelpModal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden flex items-center justify-center p-4 z-[300]">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] max-w-3xl w-full shadow-2xl animate-in zoom-in duration-300 max-h-[85dvh] flex flex-col modal-content overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-slate-100 dark:border-slate-800 shrink-0 bg-white dark:bg-slate-900 z-10">
                <h3 class="text-xl font-black">策略分支手冊</h3><button onclick="hidePersonaHelp()" class="text-slate-300 hover:text-indigo-500 p-2 -mr-2"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="overflow-y-auto p-6 pt-4 space-y-4 text-sm leading-relaxed text-slate-600 dark:text-slate-300 pb-safe">
                <details class="group bg-blue-50/50 dark:bg-blue-900/10 rounded-2xl p-4 border border-blue-100 dark:border-blue-900/20" open>
                    <summary class="flex items-center justify-between font-black text-blue-600 cursor-pointer"><span class="flex items-center gap-2"><i data-lucide="zap" class="w-4 h-4"></i> 打工型 (日級別)</span><i data-lucide="chevron-down" class="w-4 h-4 text-blue-400 transition-transform group-open:rotate-180"></i></summary>
                    <div class="mt-4 space-y-4"><div class="bg-white dark:bg-slate-900 p-3 rounded-xl border border-slate-100 dark:border-slate-800"><h5 class="font-black text-slate-800 dark:text-white mb-2">強勢日 (追漲)</h5><ul class="list-disc pl-4 space-y-1 text-xs text-slate-500 dark:text-slate-400"><li><strong>時機：</strong>10:00後觀察，確認強風/陣風。</li><li><strong>選股：</strong>營收/成交值強勢。</li><li><strong>停損：</strong>3日內未脫離成本(-1~2%)或虧損達5%。</li></ul></div><div class="bg-white dark:bg-slate-900 p-3 rounded-xl border border-slate-100 dark:border-slate-800"><h5 class="font-black text-slate-800 dark:text-white mb-2">日拉回 (低吸)</h5><ul class="list-disc pl-4 space-y-1 text-xs text-slate-500 dark:text-slate-400"><li><strong>時機：</strong>易漲循環。回測5日線。</li><li><strong>停損：</strong>3~5天未發動攻勢。</li></ul></div></div>
                </details>
                <details class="group bg-indigo-50/50 dark:bg-indigo-900/10 rounded-2xl p-4 border border-indigo-100 dark:border-indigo-900/20">
                    <summary class="flex items-center justify-between font-black text-indigo-600 cursor-pointer"><span class="flex items-center gap-2"><i data-lucide="briefcase" class="w-4 h-4"></i> 上班族 (週級別)</span><i data-lucide="chevron-down" class="w-4 h-4 text-indigo-400 transition-transform group-open:rotate-180"></i></summary>
                    <div class="mt-4 space-y-4"><div class="bg-white dark:bg-slate-900 p-3 rounded-xl border border-slate-100 dark:border-slate-800"><h5 class="font-black text-slate-800 dark:text-white mb-2">強勢週 (趨勢)</h5><ul class="list-disc pl-4 space-y-1 text-xs text-slate-500 dark:text-slate-400"><li><strong>時機：</strong>11:30後。日MACD剛翻多。</li></ul></div></div>
                </details>
                <details class="group bg-purple-50/50 dark:bg-purple-900/10 rounded-2xl p-4 border border-purple-100 dark:border-purple-900/20">
                    <summary class="flex items-center justify-between font-black text-purple-600 cursor-pointer"><span class="flex items-center gap-2"><i data-lucide="crown" class="w-4 h-4"></i> 老闆型 (月級別)</span><i data-lucide="chevron-down" class="w-4 h-4 text-purple-400 transition-transform group-open:rotate-180"></i></summary>
                     <div class="mt-4 space-y-4"><div class="bg-white dark:bg-slate-900 p-3 rounded-xl border border-slate-100 dark:border-slate-800"><h5 class="font-black text-slate-800 dark:text-white mb-2">週拉回 / 廉價收購</h5><ul class="list-disc pl-4 space-y-1 text-xs text-slate-500 dark:text-slate-400"><li><strong>核心：</strong>營收YoY>30%。月線分批。</li></ul></div></div>
                </details>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. Your Config
        const firebaseConfig = {
            apiKey: "AIzaSyB4BuO5gvNfkHYYp48FvwYhK-VXpnb7NSg",
            authDomain: "stock-app-4e8cd.firebaseapp.com",
            projectId: "stock-app-4e8cd",
            storageBucket: "stock-app-4e8cd.firebasestorage.app",
            messagingSenderId: "755625283902",
            appId: "1:755625283902:web:8789da17765e35e5e2dc6f"
        };

        // 3. Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // 4. Global State
        let currentUser = null;
        let trades = []; // Syncs with Firestore
        let unsubscribe = null; // Snapshot listener
        
        // Expose functions to window for HTML buttons
        window.trades = trades; // Debug
        
        // --- AUTH ---
        window.handleGoogleLogin = async () => {
            const btn = document.getElementById('btn-google');
            btn.innerHTML = `<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i>`;
            lucide.createIcons();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                alert("登入失敗: " + error.message);
                btn.innerHTML = `Google 登入重試`;
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            location.reload();
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.remove('blur-login');
                document.getElementById('user-avatar').src = user.photoURL;
                document.getElementById('menu-user-name').textContent = user.displayName;
                subscribeToTrades(user.uid);
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
                document.getElementById('app-content').classList.add('blur-login');
                if(unsubscribe) unsubscribe();
                trades = [];
                renderPortfolio();
            }
        });

        // --- DATABASE SYNC ---
        function subscribeToTrades(userId) {
            // Path: users/{uid}/trades
            const q = query(collection(db, "users", userId, "trades"), orderBy("createdAt", "desc"));
            unsubscribe = onSnapshot(q, (snapshot) => {
                trades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPortfolio();
                renderHistory();
                updateGlobalStats();
            });
        }

        // --- CRUD ACTIONS (Replaces localStorage) ---
        window.handleTradeSubmit = async () => {
            if(!currentUser) return alert("請先登入");
            
            const idx = document.getElementById('subStrategyInput').value;
            const price = parseFloat(document.getElementById('entryPrice').value);
            const qty = parseInt(document.getElementById('quantity').value);
            
            const newTrade = {
                persona: window.currentPersona,
                strategyIdx: idx,
                strategyName: personas[window.currentPersona].options[idx].name,
                symbolCode: document.getElementById('symbolCode').value,
                symbolName: document.getElementById('symbolName').value,
                averagePrice: price,
                totalQuantity: qty,
                entryPrice: price,
                quantity: qty,
                entryDate: document.getElementById('entryDate').value,
                entryWind: document.getElementById('entryWindInput').value,
                note: document.getElementById('note').value,
                screenshot: window.tempScreenshot || null,
                status: 'open',
                history: [{ type: 'buy', date: document.getElementById('entryDate').value, price, quantity: qty, wind: document.getElementById('entryWindInput').value, note: document.getElementById('note').value, screenshot: window.tempScreenshot || null, timestamp: Date.now() }],
                createdAt: Date.now()
            };

            const btn = document.querySelector('#tradeForm button');
            const oldText = btn.innerHTML;
            btn.innerHTML = '儲存中...';
            
            try {
                await addDoc(collection(db, "users", currentUser.uid, "trades"), newTrade);
                document.getElementById('tradeForm').reset();
                window.tempScreenshot = null;
                document.getElementById('upload-preview-container').classList.add('hidden');
                document.getElementById('upload-placeholder').classList.remove('hidden');
                document.getElementById('form-container').classList.add('hidden');
                document.querySelectorAll('.persona-card').forEach(c => c.classList.remove('selected'));
                switchTab('portfolio');
            } catch(e) {
                alert("儲存失敗");
                console.error(e);
            } finally {
                btn.innerHTML = oldText;
            }
        };

        window.confirmAddPosition = async () => {
            if(!window.tradeToAddId) return;
            const price = parseFloat(document.getElementById('addPosPrice').value);
            const qty = parseInt(document.getElementById('addPosQty').value);
            const t = trades.find(item => item.id === window.tradeToAddId);
            
            if (t && price && qty) {
                const oldTotalVal = t.averagePrice * t.totalQuantity;
                const newTotalQty = t.totalQuantity + qty;
                const newAvg = (oldTotalVal + (price * qty)) / newTotalQty;
                
                const newHistory = [...t.history, { type: 'buy', date: document.getElementById('addPosDate').value, price, quantity: qty, wind: '加碼', note: document.getElementById('addPosNote').value, timestamp: Date.now() }];
                
                await updateDoc(doc(db, "users", currentUser.uid, "trades", t.id), {
                    totalQuantity: newTotalQty,
                    averagePrice: newAvg,
                    history: newHistory
                });
                closeAddPositionModal();
            }
        };

        window.confirmSellAction = async () => {
             if(!window.tradeToSellId) return;
             const price = parseFloat(document.getElementById('sellPrice').value);
             const qty = parseInt(document.getElementById('sellQty').value);
             const t = trades.find(item => item.id === window.tradeToSellId);
             
             if (t && price && qty) {
                const newQty = t.totalQuantity - qty;
                const newHistory = [...t.history, { type: 'sell', date: document.getElementById('sellDate').value, price, quantity: qty, wind: document.getElementById('exitWindInput').value, note: document.getElementById('sellNote').value, timestamp: Date.now() }];
                
                const updateData = {
                    totalQuantity: newQty,
                    history: newHistory
                };
                
                if (newQty <= 0) {
                    updateData.status = 'closed';
                    updateData.exitPrice = price;
                    updateData.exitDate = document.getElementById('sellDate').value;
                    updateData.exitWind = document.getElementById('exitWindInput').value;
                }
                
                await updateDoc(doc(db, "users", currentUser.uid, "trades", t.id), updateData);
                closeModal();
                if(newQty <= 0) switchTab('history');
             }
        };

        window.confirmAction = async () => {
            if(window.tradeToDeleteId) {
                await deleteDoc(doc(db, "users", currentUser.uid, "trades", window.tradeToDeleteId));
            }
            closeConfirmModal();
        };

        // --- Rest of UI Logic (Adapted) ---
        // Variables that need to be global
        window.currentPersona = '';
        window.tradeToSellId = null;
        window.tradeToAddId = null;
        window.tradeToDeleteId = null;
        window.filterDates = { start: null, end: null };
        window.tempScreenshot = null;
        
        // Re-attach UI functions to window
        window.switchTab = (t) => { ['add','portfolio','history','strategy'].forEach(p=>{ document.getElementById(`page-${p}`).classList.add('hidden'); document.getElementById(`tab-${p}`).classList.remove('active'); }); document.getElementById(`page-${t}`).classList.remove('hidden'); document.getElementById(`tab-${t}`).classList.add('active'); if(t==='strategy')renderStrategyPage(); window.scrollTo(0,0); };
        window.toggleUserMenu = () => document.getElementById('user-menu').classList.toggle('hidden');
        window.toggleThemeMenu = () => document.getElementById('theme-menu').classList.toggle('hidden');
        window.setTheme = (m) => { const h=document.documentElement; if(m==='dark'){h.classList.add('dark');localStorage.setItem('kite_theme','dark');}else if(m==='light'){h.classList.remove('dark');localStorage.setItem('kite_theme','light');}else{localStorage.removeItem('kite_theme');if(window.matchMedia('(prefers-color-scheme: dark)').matches)h.classList.add('dark');else h.classList.remove('dark');} document.getElementById('theme-menu').classList.add('hidden'); updateThemeIcons(); };
        window.updateThemeIcons = () => { document.getElementById('theme-icon-light').classList.add('hidden'); document.getElementById('theme-icon-dark').classList.add('hidden'); document.getElementById('theme-icon-auto').classList.add('hidden'); const s=localStorage.getItem('kite_theme')||'system'; if(s==='light')document.getElementById('theme-icon-light').classList.remove('hidden'); else if(s==='dark')document.getElementById('theme-icon-dark').classList.remove('hidden'); else document.getElementById('theme-icon-auto').classList.remove('hidden'); };
        window.showFilterModal = () => document.getElementById('filterModal').classList.remove('hidden');
        window.hideFilterModal = () => document.getElementById('filterModal').classList.add('hidden');
        window.quickSetDate = (type) => { const today = new Date(); let s = new Date(), e = new Date(); if (type === 'thisMonth') { s = new Date(today.getFullYear(), today.getMonth(), 1); } else if (type === 'lastMonth') { s = new Date(today.getFullYear(), today.getMonth() - 1, 1); e = new Date(today.getFullYear(), today.getMonth(), 0); } else if (type === 'thisYear') { s = new Date(today.getFullYear(), 0, 1); } else if (type === 'last30') { s.setDate(today.getDate() - 30); } const fmt = d => d.toISOString().split('T')[0]; document.getElementById('filterStartDate').value = fmt(s); document.getElementById('filterEndDate').value = fmt(e); };
        window.applyDateFilter = () => { window.filterDates.start = document.getElementById('filterStartDate').value; window.filterDates.end = document.getElementById('filterEndDate').value; hideFilterModal(); renderHistory(); updateGlobalStats(); };
        window.resetDateFilter = () => { window.filterDates = {start:null, end:null}; document.getElementById('filterStartDate').value=''; document.getElementById('filterEndDate').value=''; hideFilterModal(); renderHistory(); updateGlobalStats(); };
        window.showWindHelp = () => document.getElementById('windHelpModal').classList.remove('hidden');
        window.hideWindHelp = () => document.getElementById('windHelpModal').classList.add('hidden');
        window.showPersonaHelp = () => document.getElementById('personaHelpModal').classList.remove('hidden');
        window.hidePersonaHelp = () => document.getElementById('personaHelpModal').classList.add('hidden');
        window.closeImageModal = () => document.getElementById('imageModal').classList.add('hidden');
        window.selectWind = (phase, w) => { document.querySelectorAll(`#${phase==='entry'?'entryWindContainer':'exitWindContainer'} .wind-card`).forEach(c=>c.classList.remove('selected')); document.querySelector(`#${phase==='entry'?'entryWindContainer':'exitWindContainer'} .wind-card.${w}`).classList.add('selected'); document.getElementById(`${phase==='entry'?'entryWindInput':'exitWindInput'}`).value=w; };
        
        window.selectPersona = (p) => { window.currentPersona=p; document.querySelectorAll('.persona-card').forEach(c=>c.classList.remove('selected')); document.getElementById(`p-${p}`).classList.add('selected'); document.getElementById('form-container').classList.remove('hidden'); document.getElementById('persona-indicator').style.backgroundColor=personas[p].color; const container=document.getElementById('subStrategyContainer'); container.innerHTML = personas[p].options.map((o,i)=>`<div onclick="selectStrategy(${i})" id="strat-${i}" class="cursor-pointer bg-slate-50 dark:bg-slate-800 border-2 border-transparent p-3 rounded-2xl flex items-center gap-2 btn-press"><div class="w-4 h-4 rounded-full border border-slate-300 dark:border-slate-600 flex items-center justify-center strategy-check"><div class="w-2 h-2 rounded-full bg-white opacity-0 strategy-dot"></div></div><span class="font-black text-xs text-slate-600 dark:text-slate-300">${o.name}</span></div>`).join(''); selectStrategy(0); document.getElementById('entryDate').valueAsDate = new Date(); selectWind('entry','強風'); };
        window.selectStrategy = (i) => { document.getElementById('subStrategyInput').value=i; document.querySelectorAll('#subStrategyContainer > div').forEach(c=>{ c.classList.remove('border-indigo-500','bg-indigo-50','dark:bg-indigo-900/20'); c.querySelector('.strategy-check').classList.remove('bg-indigo-600','border-indigo-600'); c.querySelector('.strategy-dot').classList.remove('opacity-100'); }); const s=document.getElementById(`strat-${i}`); if(s){ s.classList.add('border-indigo-500','bg-indigo-50','dark:bg-indigo-900/20'); const c=s.querySelector('.strategy-check'); c.classList.add('bg-indigo-600','border-indigo-600'); c.querySelector('.strategy-dot').classList.add('opacity-100'); updateSubSop(); } };
        window.updateSubSop = () => { const i=document.getElementById('subStrategyInput').value; if(i==="")return; const o=personas[window.currentPersona].options[i]; document.getElementById('persona-summary-text').textContent=o.summary; document.getElementById('rule-sl').textContent=o.sl; document.getElementById('rule-tp').textContent=o.tp; };
        
        window.handleImageUpload = (e) => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{ const img=new Image(); img.src=ev.target.result; img.onload=()=>{ const c=document.createElement('canvas'); const ctx=c.getContext('2d'); const s=800/img.width; const w=(s<1)?800:img.width; const h=(s<1)?img.height*s:img.height; c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h); window.tempScreenshot=c.toDataURL('image/jpeg',0.5); document.getElementById('upload-preview').src=window.tempScreenshot; document.getElementById('upload-placeholder').classList.add('hidden'); document.getElementById('upload-preview-container').classList.remove('hidden'); }}; r.readAsDataURL(f); };
        window.clearImage = (e) => { e.preventDefault(); window.tempScreenshot=null; document.getElementById('tradeScreenshot').value=''; document.getElementById('upload-preview').src=''; document.getElementById('upload-preview-container').classList.add('hidden'); document.getElementById('upload-placeholder').classList.remove('hidden'); };

        window.openSellModal = (id) => { window.tradeToSellId=id; const t=trades.find(item=>item.id===id); document.getElementById('sellModal').classList.remove('hidden'); document.getElementById('sellPrice').value=''; document.getElementById('sellQty').value=t.totalQuantity; document.getElementById('sellQty').max=t.totalQuantity; document.getElementById('sellNote').value=''; document.getElementById('sell-current-qty').textContent=t.totalQuantity.toLocaleString(); document.getElementById('sell-avg-cost').textContent='$'+t.averagePrice.toFixed(2); document.getElementById('sellDate').valueAsDate=new Date(); document.getElementById('sell-estimate').classList.add('hidden'); selectWind('exit','強風'); updateSellEstimate(); };
        window.updateSellEstimate = () => { if(!window.tradeToSellId)return; const t=trades.find(item=>item.id===window.tradeToSellId); const price=parseFloat(document.getElementById('sellPrice').value); const qty=parseInt(document.getElementById('sellQty').value); const el=document.getElementById('sell-estimate'); if(price&&qty&&t){ const estPnL=(price-t.averagePrice)*qty; const colorClass=estPnL>=0?'text-red-500':'text-green-600'; document.getElementById('sell-estimate-val').innerHTML=`<span class="${colorClass}">${estPnL>=0?'+':''}$${Math.round(estPnL).toLocaleString()}</span>`; el.classList.remove('hidden'); }else{ el.classList.add('hidden'); } };
        window.closeModal = () => { document.getElementById('sellModal').classList.add('hidden'); window.tradeToSellId=null; };
        
        window.addPosition = (id) => { window.tradeToAddId=id; document.getElementById('addPositionModal').classList.remove('hidden'); document.getElementById('addPosPrice').value=''; document.getElementById('addPosQty').value=''; document.getElementById('addPosNote').value=''; document.getElementById('addPosDate').valueAsDate=new Date(); };
        window.closeAddPositionModal = () => { document.getElementById('addPositionModal').classList.add('hidden'); window.tradeToAddId=null; };
        
        window.requestDelete = (id) => { window.tradeToDeleteId=id; document.getElementById('confirmModal').classList.remove('hidden'); };
        window.closeConfirmModal = () => { document.getElementById('confirmModal').classList.add('hidden'); window.tradeToDeleteId=null; };
        
        window.viewDetails = (id) => { const t=trades.find(item=>item.id===id); if(!t)return; document.getElementById('detail-title').textContent=`${t.symbolCode} ${t.symbolName}`; document.getElementById('detail-subtitle').textContent=`均價 $${t.averagePrice.toFixed(2)} / 持倉 ${t.totalQuantity}股`; const list=document.getElementById('detail-list'); let currentCost=0, currentQty=0, avgPrice=0; const sortedHistory=[...t.history].sort((a,b)=>a.timestamp-b.timestamp); const htmlItems=sortedHistory.map(h=>{ let pnlDisplay=''; if(h.type==='buy'){ currentCost+=h.price*h.quantity; currentQty+=h.quantity; avgPrice=currentCost/currentQty; }else if(h.type==='sell'){ let cost=avgPrice*h.quantity; let realizedPnL=(h.price-avgPrice)*h.quantity; let pct=cost>0?((realizedPnL/cost)*100).toFixed(1):0; const pnlClass=realizedPnL>=0?'text-red-500':'text-green-600'; pnlDisplay=`<div class="mt-2 pt-2 border-t dark:border-slate-700 flex justify-between items-center text-xs font-bold ${pnlClass}"><span>損益: ${realizedPnL>=0?'+':''}$${Math.round(realizedPnL).toLocaleString()} (${pct}%)</span></div>`; currentCost-=avgPrice*h.quantity; currentQty-=h.quantity; } return `<div class="p-4 rounded-2xl border ${h.type==='buy'?'bg-indigo-50/50 border-indigo-100 dark:bg-indigo-900/10 dark:border-indigo-900/30':'bg-slate-50 border-slate-200 dark:bg-slate-800 dark:border-slate-700'}"><div class="flex justify-between items-center mb-1"><span class="text-[10px] font-black uppercase px-2 py-0.5 rounded ${h.type==='buy'?'bg-indigo-100 text-indigo-600 dark:bg-indigo-900 dark:text-indigo-300':'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300'}">${h.type==='buy'?'買進':'賣出'}</span><span class="text-[10px] text-slate-400 font-bold">${h.date}</span></div><div class="flex justify-between items-center"><span class="text-sm font-black text-slate-700 dark:text-slate-200">${h.quantity}股 @ $${h.price}</span><span class="text-[10px] font-bold text-slate-400">${h.wind||'-'}</span></div>${h.note?`<p class="text-[10px] text-slate-500 mt-2 leading-relaxed">${h.note}</p>`:''} ${pnlDisplay}</div>`; }); list.innerHTML=htmlItems.reverse().join(''); document.getElementById('detailsModal').classList.remove('hidden'); };
        window.closeDetailsModal = () => document.getElementById('detailsModal').classList.add('hidden');

        // Render Functions
        const personas={freelancer:{title:'打工型',color:'#3b82f6',options:[{name:'強勢日(追漲)',summary:'10:00後。買紅追漲。週MACD向上。',sl:'3日內未脫離成本或虧損5%。',tp:'獲利10%+，破5/10日線。'},{name:'日拉回(低吸)',summary:'拉回5日線進場。分批。',sl:'3~5天沒攻勢或破5日線。',tp:'獲利10%+，且跌破5日/10日線。'}]},office:{title:'上班族',color:'#6366f1',options:[{name:'強勢週(趨勢)',summary:'11:30後。日MACD剛翻多。',sl:'買進4日內未脫離成本。',tp:'獲利10%+，破5/10日線。'},{name:'週趨勢(拉回)',summary:'週MACD剛翻多。拉回買。',sl:'週五收盤低於上週五。',tp:'獲利10%+，週MACD縮短。'}]},boss:{title:'老闆型',color:'#a855f7',options:[{name:'週拉回(分批)',summary:'營收YoY>30%。月線分批。',sl:'月MACD縮短。營收轉負。',tp:'週K站不回5週線。'},{name:'廉價收購(價值)',summary:'回檔至季線。大資金分批。',sl:'金流撤退(月MACD縮)。',tp:'週K站不回5週線。'}]}};
        const windColors={'強風':'bg-red-500','亂流':'bg-amber-500','陣風':'bg-blue-500','無風':'bg-slate-400'};
        function formatLargeNumber(n){const a=Math.abs(n);if(a>=1000000000000)return(a/1000000000000).toFixed(2)+'兆';if(a>=100000000)return(a/100000000).toFixed(2)+'億';if(a>=10000)return(a/10000).toFixed(1)+'萬';return Math.round(a).toLocaleString();}

        window.renderPortfolio = () => {
            const list=document.getElementById('portfolio-list'); const openTrades=trades.filter(t=>t.status==='open').sort((a,b)=>b.createdAt-a.createdAt);
            if(openTrades.length===0){ list.innerHTML=`<div class="col-span-full text-center py-12 text-slate-300 font-bold text-xs border-2 border-dashed rounded-3xl border-slate-100 dark:border-slate-800">無持倉</div>`;return;}
            list.innerHTML=openTrades.map(t=>`<div class="bg-white dark:bg-slate-900 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-800 btn-press" onclick="viewDetails('${t.id}')"><div class="flex justify-between items-start mb-3"><div class="flex items-center gap-2"><span class="text-[10px] font-black px-2 py-0.5 rounded-lg text-white" style="background-color: ${personas[t.persona].color}">${t.strategyName}</span><h3 class="text-lg font-black">${t.symbolName}</h3></div><div class="flex gap-2" onclick="event.stopPropagation()"><button onclick="addPosition('${t.id}')" class="bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-300 px-3 py-1.5 rounded-xl flex items-center gap-1 active:scale-95 transition-transform"><i data-lucide="plus" class="w-3.5 h-3.5"></i><span class="text-[10px] font-black">加碼</span></button><button onclick="openSellModal('${t.id}')" class="bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300 px-3 py-1.5 rounded-xl flex items-center gap-1 active:scale-95 transition-transform"><i data-lucide="log-out" class="w-3.5 h-3.5"></i><span class="text-[10px] font-black">平倉</span></button><button onclick="requestDelete('${t.id}')" class="bg-red-50 text-red-400 dark:bg-red-900/20 dark:text-red-300 p-2 rounded-xl active:scale-95 transition-transform"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div><div class="grid grid-cols-2 gap-2 text-center"><div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-xl"><p class="text-[9px] text-slate-400 font-bold uppercase">成本</p><p class="text-sm font-black">$${t.averagePrice.toFixed(1)}</p></div><div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-xl"><p class="text-[9px] text-slate-400 font-bold uppercase">持倉</p><p class="text-sm font-black">${t.totalQuantity}</p></div></div></div>`).join(''); lucide.createIcons();
        };

        window.renderHistory = () => {
            const list=document.getElementById('history-list'); const stats=document.getElementById('history-stats');
            let closed=trades.filter(t=>t.status==='closed');
            if(window.filterDates.start&&window.filterDates.end){ closed=closed.filter(t=>t.exitDate>=window.filterDates.start&&t.exitDate<=window.filterDates.end); }
            let tPL=0, wins=0, count=0;
            closed.forEach(t=>{ let pnl=0; t.history.forEach(h=>{if(h.type==='sell')pnl+=(h.price-t.averagePrice)*h.quantity}); tPL+=pnl; if(pnl>0)wins++; count++; });
            stats.innerHTML=`<div class="bg-slate-900 text-white p-4 rounded-[2rem] shadow-lg"><p class="text-[10px] font-black text-slate-400 uppercase">總損益</p><p class="text-xl font-black ${tPL>=0?'text-red-400':'text-green-400'}">${tPL>=0?'+':''}$${formatLargeNumber(tPL)}</p></div><div class="bg-white dark:bg-slate-900 p-4 rounded-[2rem] border border-slate-100 dark:border-slate-800"><p class="text-[10px] font-black text-slate-400 uppercase">勝率</p><p class="text-xl font-black dark:text-white">${count>0?((wins/count)*100).toFixed(0):0}%</p></div>`;
            if(closed.length===0){ list.innerHTML=`<div class="text-center py-10 text-slate-300 text-xs">無紀錄</div>`;return;}
            list.innerHTML=closed.map(t=>{ let pnl=0,cost=0; t.history.forEach(h=>{if(h.type==='sell'){pnl+=(h.price-t.averagePrice)*h.quantity;cost+=t.averagePrice*h.quantity}}); let pct=cost>0?((pnl/cost)*100).toFixed(1):0; return `<div class="bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-50 dark:border-slate-800 flex items-center justify-between btn-press" onclick="viewDetails('${t.id}')"><div class="flex items-center gap-3"><div class="w-1 h-8 rounded-full" style="background-color: ${pnl>=0?'#f87171':'#4ade80'}"></div><div><h3 class="font-black text-sm dark:text-white">${t.symbolName}</h3><p class="text-[10px] text-slate-400 font-bold">${t.strategyName}</p></div></div><div class="flex items-center gap-3"><div class="text-right"><p class="text-base font-black ${pnl>=0?'text-red-500':'text-green-600'}">${pnl>=0?'+':''}$${formatLargeNumber(pnl)}</p><p class="text-[10px] font-bold ${pnl>=0?'text-red-400':'text-green-500'}">${pnl>=0?'+':''}${pct}%</p></div><button onclick="event.stopPropagation(); requestDelete('${t.id}')" class="p-2 text-slate-400 hover:text-red-500 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-all active:scale-95"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`; }).join(''); lucide.createIcons();
        };

        window.updateGlobalStats = () => {
            let tPL=0, tCost=0;
            trades.forEach(t=>{ t.history.forEach(h=>{ if(h.type==='sell'){ if(window.filterDates.start&&window.filterDates.end&&(h.date<window.filterDates.start||h.date>window.filterDates.end))return; let pnl=(h.price-t.averagePrice)*h.quantity; tPL+=pnl; tCost+=t.averagePrice*h.quantity; }});});
            const plEl=document.getElementById('header-total-pl'); const pctEl=document.getElementById('header-total-pct');
            if(plEl){ plEl.textContent=`$${formatLargeNumber(tPL)}`; plEl.className=`text-base xs:text-lg font-black leading-tight ${tPL>=0?'text-red-500':'text-green-600'}`; }
            if(pctEl){ let roi=tCost>0?((tPL/tCost)*100).toFixed(1):0.0; pctEl.textContent=`${roi>=0?'+':''}${roi}%`; pctEl.className=`text-[10px] font-bold mt-1 ${roi>=0?'text-red-400':'text-green-500'}`; }
            document.getElementById('header-portfolio-count').textContent=trades.filter(t=>t.status==='open').length;
            let w=0,c=0; trades.filter(t=>t.status==='closed').forEach(t=>{let p=0;t.history.forEach(h=>{if(h.type==='sell')p+=(h.price-t.averagePrice)*h.quantity});if(p>0)w++;c++;});
            document.getElementById('header-win-rate').textContent=c>0?((w/c)*100).toFixed(0)+'%':'0%';
            if(window.filterDates.start){document.getElementById('filter-active-range').classList.remove('hidden');document.getElementById('filter-all-label').classList.add('hidden');}else{document.getElementById('filter-active-range').classList.add('hidden');document.getElementById('filter-all-label').classList.remove('hidden');}
        };

        // Initialize UI
        setTheme(localStorage.getItem('kite_theme')||'system');
        lucide.createIcons();
    </script>
</body>
</html>

